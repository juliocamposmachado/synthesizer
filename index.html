<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <!-- Primary Meta Tags -->
  <title>üéõÔ∏è Synthesizer - Sintetizador e Bateria Virtual | Like Look Solutions</title>
  <meta name="title" content="üéõÔ∏è Synthesizer - Sintetizador e Bateria Virtual | Like Look Solutions" />
  <meta name="description" content="Aplica√ß√£o web interativa que combina sintetizador e sequenciador de bateria com 32 steps, 16 pads musicais, patches de ritmo e interface drag & drop moderna." />
  <meta name="keywords" content="sintetizador, bateria virtual, sequenciador, m√∫sica, web audio api, drum pads, synthesizer, beats, ritmos, m√∫sica eletr√¥nica" />
  <meta name="author" content="Julio Campos Machado - Like Look Solutions" />
  <meta name="robots" content="index, follow" />
  <meta name="language" content="Portuguese" />
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://synthesizer-two.vercel.app/" />
  <meta property="og:title" content="üéõÔ∏è Synthesizer - Sintetizador e Bateria Virtual" />
  <meta property="og:description" content="Crie m√∫sica com 16 pads de bateria, sintetizador completo, sequenciador de 32 steps e patches de ritmo. Interface moderna com drag & drop e anima√ß√µes fluidas." />
  <meta property="og:image" content="https://synthesizer-two.vercel.app/og-image.svg" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:site_name" content="Synthesizer - Like Look Solutions" />
  <meta property="og:locale" content="pt_BR" />
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image" />
  <meta property="twitter:url" content="https://synthesizer-two.vercel.app/" />
  <meta property="twitter:title" content="üéõÔ∏è Synthesizer - Sintetizador e Bateria Virtual" />
  <meta property="twitter:description" content="Crie m√∫sica com 16 pads de bateria, sintetizador completo, sequenciador de 32 steps e patches de ritmo. Interface moderna com drag & drop." />
  <meta property="twitter:image" content="https://synthesizer-two.vercel.app/og-image.svg" />
  <meta name="twitter:creator" content="@juliocamposmachado" />
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <link rel="icon" type="image/png" sizes="32x32" href="favicon.svg" />
  <link rel="icon" type="image/png" sizes="16x16" href="favicon.svg" />
  <link rel="apple-touch-icon" href="favicon.svg" />
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#1fb6ff" />
  <meta name="msapplication-TileColor" content="#071029" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Synthesizer" />
  
  <!-- Additional Meta Tags -->
  <meta name="format-detection" content="telephone=no" />
  <link rel="canonical" href="https://synthesizer-two.vercel.app/" />
  
  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Synthesizer - Sintetizador e Bateria Virtual",
    "description": "Aplica√ß√£o web interativa para cria√ß√£o musical com sintetizador, bateria virtual e sequenciador avan√ßado",
    "url": "https://synthesizer-two.vercel.app/",
    "author": {
      "@type": "Person",
      "name": "Julio Campos Machado",
      "url": "https://github.com/juliocamposmachado"
    },
    "publisher": {
      "@type": "Organization",
      "name": "Like Look Solutions",
      "url": "https://likelook.wixsite.com/solutions"
    },
    "applicationCategory": "Music",
    "operatingSystem": "Web Browser",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    }
  }
  </script>
  <style>
    :root{--bg:#0b1220;--card:#0f1724;--accent:#1fb6ff;--muted:#98a0b3;--success:#2ed573;--danger:#ff4757;--warning:#ffa502}
    
    * { box-sizing: border-box; }
    
    html,body{height:100%;margin:0;font-family:'Inter',system-ui,-apple-system,Arial,sans-serif;color:#e6eef8;background:linear-gradient(180deg,#071029 0%, #071b2f 100%);line-height:1.5}
    
    /* Layout com tabela 3 colunas */
    .app {
      width: 100%;
      max-width: none;
      margin: 0;
      padding: 20px;
      min-height: calc(100vh - 40px);
      display: table;
      table-layout: fixed;
      border-collapse: separate;
      border-spacing: 20px;
    }

    .app-row {
      display: table-row;
      width: 100%;
    }

    .card-column {
      display: table-cell;
      vertical-align: top;
      width: 33.333%;
      min-width: 300px;
      padding: 0;
      position: relative;
    }

    /* Colunas ajust√°veis com resize */
    .card-column:not(:last-child) {
      border-right: 3px solid rgba(255,255,255,0.1);
      cursor: col-resize;
      position: relative;
    }

    .card-column:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 0;
      right: -6px;
      width: 12px;
      height: 100%;
      cursor: col-resize;
      background: transparent;
      z-index: 1000;
    }

    .card-column:not(:last-child):hover::after {
      background: rgba(31,182,255,0.2);
    }
    
    .layout-toggle{
      position:fixed;
      top:20px;
      right:20px;
      background:var(--accent);
      border:none;
      color:#022233;
      padding:12px 16px;
      border-radius:8px;
      cursor:pointer;
      font-size:12px;
      font-weight:600;
      text-transform:uppercase;
      z-index:10004;
      transition:all 0.2s ease;
      box-shadow:0 4px 15px rgba(31,182,255,0.4);
      backdrop-filter:blur(10px);
      user-select:none;
    }
    
    .layout-toggle:hover{
      transform:translateY(-2px);
      box-shadow:0 6px 20px rgba(31,182,255,0.6);
    }
    
    .card-container{
      width: 100%;
      margin-bottom: 20px;
    }
    
    .card{
      background:rgba(255,255,255,0.05);
      border-radius:16px;
      padding:20px;
      box-shadow:0 8px 32px rgba(2,6,23,0.4);
      border:1px solid rgba(255,255,255,0.08);
      backdrop-filter:blur(10px);
      cursor:move;
      transition:all 0.3s ease;
      position:relative;
      resize:both;
      overflow:auto;
      width:100%;
      min-height:250px;
      height:auto;
      box-sizing: border-box;
    }

    /* Cards s√£o redimension√°veis */
    .card:hover {
      border-color: rgba(31,182,255,0.3);
    }
    
    .card.dragging{
      opacity:0.7;
      transform:rotate(3deg) scale(1.02);
      z-index:1000;
      box-shadow:0 15px 50px rgba(31,182,255,0.3);
    }
    
    .card.collapsed .card-content{
      display:none;
      opacity:0;
      transform:scaleY(0);
    }
    
    .card.collapsed{
      padding:12px 20px;
      width:auto;
      min-width:280px;
      max-width:450px;
      transform-origin:center center;
      transition:all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    
    .card-content{
      opacity:1;
      transform:scaleY(1);
      transform-origin:center top;
      transition:all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    
    .card:not(.collapsed){
      transform-origin:center center;
    }
    
    /* Resize indicator */
    .card::after{
      content:'‚Üò';
      position:absolute;
      bottom:8px;
      right:8px;
      font-size:16px;
      color:rgba(255,255,255,0.3);
      pointer-events:none;
      transition:all 0.2s ease;
    }
    
    .card:hover::after{
      color:var(--accent);
      transform:scale(1.2);
    }
    
    .card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:20px;
      padding-bottom:12px;
      border-bottom:1px solid rgba(255,255,255,0.1);
      cursor:grab;
      user-select:none;
    }
    
    .card-header:active{
      cursor:grabbing;
    }
    
    .card-controls{
      display:flex;
      gap:8px;
      align-items:center;
    }
    
    .card-btn{
      background:rgba(255,255,255,0.1);
      border:1px solid rgba(255,255,255,0.2);
      color:#fff;
      width:28px;
      height:28px;
      border-radius:6px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:14px;
      transition:all 0.2s ease;
      user-select:none;
    }
    
    .card-btn:hover{
      background:var(--accent);
      border-color:var(--accent);
      color:#022233;
      transform:scale(1.1);
    }
    
    .collapse-btn.collapsed{
      background:var(--warning);
      border-color:var(--warning);
      color:#022233;
    }

    .pin-btn.pinned{
      background:var(--success);
      border-color:var(--success);
      color:#022233;
      transform:scale(1.1);
    }

    .card.pinned{
      cursor:default !important;
    }

    .card.pinned .card-header{
      cursor:default !important;
    }
    
    .card-title{
      font-size:20px;
      font-weight:700;
      color:#fff;
      margin:0;
      display:flex;
      align-items:center;
      gap:8px;
    }
    
    .card-subtitle{
      font-size:14px;
      color:var(--muted);
      margin:8px 0 0 0;
    }
    
    .section{
      margin-bottom:24px;
    }
    
    .section:last-child{
      margin-bottom:0;
    }
    
    .section-title{
      font-size:16px;
      font-weight:600;
      margin-bottom:12px;
      color:var(--accent);
      text-transform:uppercase;
      letter-spacing:0.5px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    
    .pads-table{
      width:100%;
      border-collapse:separate;
      border-spacing:8px;
    }
    
    .pads-table td{
      padding:0;
      vertical-align:top;
    }
    
    .pad{
      width:100%;
      background:linear-gradient(135deg,rgba(255,255,255,0.1),rgba(255,255,255,0.05));
      border:1px solid rgba(255,255,255,0.15);
      padding:12px 8px;
      border-radius:12px;
      cursor:pointer;
      user-select:none;
      text-align:center;
      font-size:11px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.5px;
      transition:all 0.2s ease;
      min-height:48px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    
    .pad:hover{
      transform:translateY(-2px);
      box-shadow:0 6px 20px rgba(0,0,0,0.3);
      border-color:rgba(255,255,255,0.3);
    }
    
    .pad:active{
      transform:translateY(1px);
      transition:transform 0.05s ease;
    }
    
    /* Drum pad colors */
    .pad-kick{background:linear-gradient(135deg,#ff4757,#ff3838);color:white;border:1px solid #ff3838}
    .pad-snare{background:linear-gradient(135deg,#ffa502,#ff6348);color:white;border:1px solid #ff6348}
    .pad-hat{background:linear-gradient(135deg,#70a1ff,#5352ed);color:white;border:1px solid #5352ed}
    .pad-crash{background:linear-gradient(135deg,#7bed9f,#2ed573);color:white;border:1px solid #2ed573}
    .pad-ride{background:linear-gradient(135deg,#dda0dd,#9b59b6);color:white;border:1px solid #9b59b6}
    .pad-tom{background:linear-gradient(135deg,#ffb8b8,#ff7675);color:white;border:1px solid #ff7675}
    .pad-openhat{background:linear-gradient(135deg,#74b9ff,#0984e3);color:white;border:1px solid #0984e3}
    .pad-clap{background:linear-gradient(135deg,#fd79a8,#e84393);color:white;border:1px solid #e84393}
    .pad-perc{background:linear-gradient(135deg,#fdcb6e,#e17055);color:white;border:1px solid #e17055}
    
    /* Piano & Keyboard colors */
    .pad-piano{background:linear-gradient(135deg,#636e72,#2d3436);color:white;border:1px solid #2d3436}
    .pad-epiano{background:linear-gradient(135deg,#fd79a8,#e84393);color:white;border:1px solid #e84393}
    .pad-grandpiano{background:linear-gradient(135deg,#2d3436,#636e72);color:white;border:1px solid #2d3436}
    .pad-harpsichord{background:linear-gradient(135deg,#fdcb6e,#e17055);color:white;border:1px solid #e17055}
    .pad-ragtime{background:linear-gradient(135deg,#fab1a0,#ff7675);color:white;border:1px solid #ff7675}
    .pad-musicbox{background:linear-gradient(135deg,#74b9ff,#0984e3);color:white;border:1px solid #0984e3}
    
    /* Organ & Keys colors */
    .pad-organ{background:linear-gradient(135deg,#55a3ff,#2d3436);color:white;border:1px solid #2d3436}
    .pad-hammond{background:linear-gradient(135deg,#e17055,#d63031);color:white;border:1px solid #d63031}
    .pad-church{background:linear-gradient(135deg,#dda0dd,#9b59b6);color:white;border:1px solid #9b59b6}
    .pad-accordion{background:linear-gradient(135deg,#00b894,#00cec9);color:white;border:1px solid #00cec9}
    .pad-harmonica{background:linear-gradient(135deg,#fd79a8,#e84393);color:white;border:1px solid #e84393}
    .pad-concertina{background:linear-gradient(135deg,#a29bfe,#6c5ce7);color:white;border:1px solid #6c5ce7}
    
    /* Synthesizer colors */
    .pad-lead{background:linear-gradient(135deg,#fd79a8,#e84393);color:white;border:1px solid #e84393}
    .pad-bass{background:linear-gradient(135deg,#a29bfe,#6c5ce7);color:white;border:1px solid #6c5ce7}
    .pad-pad{background:linear-gradient(135deg,#00cec9,#00b894);color:white;border:1px solid #00b894}
    .pad-pluck{background:linear-gradient(135deg,#fab1a0,#e17055);color:white;border:1px solid #e17055}
    .pad-arp{background:linear-gradient(135deg,#74b9ff,#0984e3);color:white;border:1px solid #0984e3}
    .pad-sequence{background:linear-gradient(135deg,#55a3ff,#0984e3);color:white;border:1px solid #0984e3}
    .pad-polysynth{background:linear-gradient(135deg,#fd79a8,#e84393);color:white;border:1px solid #e84393}
    .pad-monosynth{background:linear-gradient(135deg,#a29bfe,#6c5ce7);color:white;border:1px solid #6c5ce7}
    .pad-fm{background:linear-gradient(135deg,#00b894,#00cec9);color:white;border:1px solid #00cec9}
    
    /* String instrument colors */
    .pad-violin{background:linear-gradient(135deg,#fab1a0,#e17055);color:white;border:1px solid #e17055}
    .pad-viola{background:linear-gradient(135deg,#fdcb6e,#e17055);color:white;border:1px solid #e17055}
    .pad-cello{background:linear-gradient(135deg,#e17055,#d63031);color:white;border:1px solid #d63031}
    .pad-contrabass{background:linear-gradient(135deg,#d63031,#c0392b);color:white;border:1px solid #c0392b}
    .pad-strings{background:linear-gradient(135deg,#fd79a8,#e84393);color:white;border:1px solid #e84393}
    .pad-pizzicato{background:linear-gradient(135deg,#fab1a0,#ff7675);color:white;border:1px solid #ff7675}
    
    /* Guitar colors */
    .pad-acoustic{background:linear-gradient(135deg,#fab1a0,#e17055);color:white;border:1px solid #e17055}
    .pad-electric{background:linear-gradient(135deg,#fd79a8,#e84393);color:white;border:1px solid #e84393}
    .pad-distorted{background:linear-gradient(135deg,#ff4757,#ff3838);color:white;border:1px solid #ff3838}
    .pad-clean{background:linear-gradient(135deg,#74b9ff,#0984e3);color:white;border:1px solid #0984e3}
    .pad-muted{background:linear-gradient(135deg,#636e72,#2d3436);color:white;border:1px solid #2d3436}
    .pad-overdrive{background:linear-gradient(135deg,#ffa502,#ff6348);color:white;border:1px solid #ff6348}
    
    /* Wind instrument colors */
    .pad-trumpet{background:linear-gradient(135deg,#fdcb6e,#f39c12);color:white;border:1px solid #f39c12}
    .pad-trombone{background:linear-gradient(135deg,#e17055,#d35400);color:white;border:1px solid #d35400}
    .pad-horn{background:linear-gradient(135deg,#fd79a8,#e84393);color:white;border:1px solid #e84393}
    .pad-tuba{background:linear-gradient(135deg,#a29bfe,#6c5ce7);color:white;border:1px solid #6c5ce7}
    .pad-saxophone{background:linear-gradient(135deg,#fdcb6e,#e17055);color:white;border:1px solid #e17055}
    .pad-flute{background:linear-gradient(135deg,#74b9ff,#0984e3);color:white;border:1px solid #0984e3}
    .pad-clarinet{background:linear-gradient(135deg,#636e72,#2d3436);color:white;border:1px solid #2d3436}
    .pad-oboe{background:linear-gradient(135deg,#fab1a0,#e17055);color:white;border:1px solid #e17055}
    .pad-bassoon{background:linear-gradient(135deg,#d63031,#c0392b);color:white;border:1px solid #c0392b}
    
    /* Effect colors */
    .pad-fx{background:linear-gradient(135deg,#a29bfe,#74b9ff);color:white;border:1px solid #74b9ff}
    .pad-noise{background:linear-gradient(135deg,#636e72,#2d3436);color:white;border:1px solid #2d3436}
    .pad-sweep{background:linear-gradient(135deg,#00b894,#00cec9);color:white;border:1px solid #00cec9}
    
    /* Controls and buttons */
    .controls-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:16px;
    }
    
    @media (min-width: 768px) {
      .controls-grid { grid-template-columns: 1fr 1fr; }
    }
    
    .control-group{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    
    .control-row{
      display:flex;
      align-items:center;
      gap:12px;
    }
    
    .control-label{
      font-size:12px;
      color:var(--muted);
      min-width:80px;
      font-weight:500;
    }
    
    .btn-group{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    
    .btn{
      background:var(--accent);
      border:none;
      color:#022233;
      padding:10px 16px;
      border-radius:8px;
      cursor:pointer;
      font-size:13px;
      font-weight:600;
      transition:all 0.2s ease;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(31,182,255,0.3);
    }
    
    .btn.danger{background:var(--danger)}
    .btn.success{background:var(--success)}
    .btn.muted{background:transparent;border:2px solid rgba(255,255,255,0.15);color:var(--muted)}
    
    /* Sequencer styles */
    .sequencer-container{
      background:rgba(0,0,0,0.3);
      border-radius:12px;
      padding:16px;
      overflow-x:auto;
      position:relative;
    }
    
    .sequencer-grid{
      position:relative;
      width:100%;
    }
    
    .sequencer-table{
      width:100%;
      min-width:1200px;
      border-collapse:separate;
      border-spacing:1px;
      background:rgba(0,0,0,0.2);
      border-radius:8px;
    }
    
    .sequencer-table th{
      background:linear-gradient(135deg, rgba(31,182,255,0.15), rgba(31,182,255,0.08));
      color:var(--accent);
      padding:10px 6px;
      text-align:center;
      font-size:11px;
      border-radius:6px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.5px;
      border:1px solid rgba(31,182,255,0.2);
    }
    
    .sequencer-table th:first-child{
      background:linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
      color:#fff;
      font-size:12px;
      min-width:100px;
      max-width:100px;
    }
    
    .sequencer-table tbody tr{
      background:rgba(255,255,255,0.02);
    }
    
    .sequencer-table tbody tr:nth-child(odd){
      background:rgba(255,255,255,0.04);
    }
    
    .track-name-cell{
      background:linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04)) !important;
      color:#fff;
      padding:12px 16px;
      font-size:11px;
      border-radius:6px;
      font-weight:700;
      text-align:center;
      text-transform:uppercase;
      letter-spacing:0.5px;
      border:1px solid rgba(255,255,255,0.1);
      min-width:100px;
      max-width:100px;
    }
    
    .step-cell{
      background:linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      border:2px solid rgba(255,255,255,0.1);
      width:24px;
      height:24px;
      cursor:pointer;
      border-radius:6px;
      position:relative;
      transition:all 0.2s ease;
      text-align:center;
      vertical-align:middle;
    }
    
    .step-cell:hover{
      border-color:var(--accent);
      background:rgba(31,182,255,0.1);
    }
    
    .step-cell.active{
      background:var(--accent);
      border-color:var(--accent);
      box-shadow:0 0 10px rgba(31,182,255,0.5);
    }
    
    .step-cell.current{
      border-color:#fff;
      box-shadow:0 0 15px rgba(255,255,255,0.8);
      animation:currentStep 0.6s ease-in-out;
    }
    
    @keyframes currentStep{
      0%,100%{transform:scale(1)}
      50%{transform:scale(1.1)}
    }
    
    .playhead{
      position:absolute;
      top:20px;
      bottom:20px;
      width:3px;
      background:linear-gradient(180deg, #fff, var(--accent));
      border-radius:2px;
      transition:left 0.15s ease;
      z-index:10;
      box-shadow:0 0 15px rgba(255,255,255,0.8),
                  0 0 30px rgba(31,182,255,0.4);
      pointer-events:none;
    }
    
    .seq-controls{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:16px;
    }
    
    .seq-btn{
      background:var(--accent);
      border:none;
      color:#022233;
      padding:8px 14px;
      border-radius:8px;
      cursor:pointer;
      font-size:12px;
      font-weight:600;
      transition:all 0.2s ease;
      text-transform:uppercase;
    }
    
    .seq-btn.danger{background:var(--danger)}
    .seq-btn.success{background:var(--success)}
    .seq-btn.recording{
      background:var(--danger);
      animation:pulse 1.2s ease-in-out infinite;
    }
    
    @keyframes pulse{
      0%,100%{opacity:1;transform:scale(1)}
      50%{opacity:0.8;transform:scale(1.05)}
    }
    
    .bpm-control{
      display:flex;
      align-items:center;
      gap:8px;
      margin-left:16px;
    }
    
    .bpm-display{
      font-size:12px;
      color:var(--muted);
      font-weight:600;
    }
    /* XY Canvas */
    #xyCanvas{
      width:100%;
      height:400px;
      background:linear-gradient(135deg,#071b2f,#04202a,#051a28);
      border-radius:16px;
      touch-action:none;
      border:2px solid rgba(255,255,255,0.1);
      box-shadow:inset 0 4px 20px rgba(0,0,0,0.3);
    }
    
    @media (min-width: 768px) {
      #xyCanvas { height: 450px; }
    }
    
    /* Form elements */
    input[type=range]{
      -webkit-appearance:none;
      height:8px;
      background:rgba(255,255,255,0.1);
      border-radius:4px;
      outline:none;
      flex:1;
      min-width:100px;
    }
    
    input[type=range]::-webkit-slider-thumb{
      -webkit-appearance:none;
      width:20px;
      height:20px;
      background:var(--accent);
      border-radius:50%;
      cursor:pointer;
      box-shadow:0 2px 8px rgba(31,182,255,0.4);
    }
    
    select{
      background:rgba(255,255,255,0.1);
      border:2px solid rgba(255,255,255,0.15);
      color:#fff;
      padding:8px 12px;
      border-radius:8px;
      font-size:13px;
    }
    
    .xy-info{
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:16px;
      margin-top:16px;
    }
    
    .meta{
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }
    
    .preset-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));
      gap:8px;
    }
    
    .preset{
      background:rgba(255,255,255,0.05);
      padding:10px 12px;
      border-radius:8px;
      border:2px solid rgba(255,255,255,0.1);
      cursor:pointer;
      text-align:center;
      font-size:12px;
      font-weight:500;
      transition:all 0.2s ease;
    }
    
    .preset:hover{
      border-color:var(--accent);
      background:rgba(31,182,255,0.1);
      transform:translateY(-1px);
    }
    
    /* Drag and Drop */
    .drop-zone{
      min-height:100px;
      border:2px dashed rgba(255,255,255,0.2);
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
      font-size:14px;
      margin:10px;
      transition:all 0.3s ease;
      background:rgba(255,255,255,0.02);
    }
    
    .drop-zone.drag-over{
      border-color:var(--accent);
      background:rgba(31,182,255,0.1);
      color:var(--accent);
      transform:scale(1.02);
    }
    
    .drop-hint{
      display:none;
      position:fixed;
      top:10px;
      right:10px;
      background:var(--accent);
      color:#022233;
      padding:8px 12px;
      border-radius:8px;
      font-size:12px;
      font-weight:600;
      z-index:10001;
      animation:bounceIn 0.3s ease;
    }
    
    .drop-hint.show{
      display:block;
    }
    
    @keyframes bounceIn{
      0%{opacity:0;transform:scale(0.3)}
      50%{opacity:1;transform:scale(1.05)}
      100%{opacity:1;transform:scale(1)}
    }
    
    /* Layout reorganization indicators */
    .layout-indicator{
      position:fixed;
      top:50%;
      left:50%;
      transform:translate(-50%, -50%);
      background:rgba(0,0,0,0.8);
      color:#fff;
      padding:16px 24px;
      border-radius:12px;
      font-size:14px;
      font-weight:600;
      z-index:10002;
      display:none;
      backdrop-filter:blur(10px);
    }
    
    .layout-indicator.show{
      display:block;
      animation:fadeInOut 2s ease;
    }
    
    @keyframes fadeInOut{
      0%,100%{opacity:0;transform:translate(-50%, -50%) scale(0.8)}
      50%{opacity:1;transform:translate(-50%, -50%) scale(1)}
    }
    
    /* Splash Screen Styles */
    .splash-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #071029 0%, #0a1a3a 50%, #071b2f 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      opacity: 1;
      transition: opacity 0.8s ease, visibility 0.8s ease;
      overflow: hidden;
    }
    
    .splash-screen.fade-out {
      opacity: 0;
      visibility: hidden;
    }
    
    .splash-content {
      text-align: center;
      color: #fff;
      z-index: 2;
      max-width: 600px;
      padding: 20px;
      animation: splashFadeIn 1s ease-out;
    }
    
    .splash-logo {
      margin-bottom: 40px;
      animation: splashPulse 2s ease-in-out infinite;
    }
    
    .logo-icon {
      font-size: 80px;
      margin-bottom: 20px;
      filter: drop-shadow(0 0 20px rgba(31, 182, 255, 0.5));
    }
    
    .logo-title {
      font-size: 48px;
      font-weight: 900;
      background: linear-gradient(45deg, #1fb6ff, #00d2ff, #1fb6ff);
      background-size: 200% 200%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: gradientShift 3s ease-in-out infinite;
      margin-bottom: 10px;
      text-shadow: 0 4px 20px rgba(31, 182, 255, 0.3);
    }
    
    .logo-subtitle {
      font-size: 18px;
      color: #98a0b3;
      font-weight: 400;
      opacity: 0.9;
    }
    
    .splash-features {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 40px 0;
      max-width: 500px;
    }
    
    .feature {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(255, 255, 255, 0.05);
      padding: 16px 20px;
      border-radius: 12px;
      border: 1px solid rgba(31, 182, 255, 0.2);
      backdrop-filter: blur(10px);
      animation: featureSlideIn 0.6s ease-out forwards;
      opacity: 0;
      transform: translateY(20px);
    }
    
    .feature:nth-child(1) { animation-delay: 0.2s; }
    .feature:nth-child(2) { animation-delay: 0.4s; }
    .feature:nth-child(3) { animation-delay: 0.6s; }
    .feature:nth-child(4) { animation-delay: 0.8s; }
    
    .feature-icon {
      font-size: 24px;
      filter: drop-shadow(0 0 10px rgba(31, 182, 255, 0.4));
    }
    
    .feature-text {
      font-size: 14px;
      font-weight: 600;
      color: #e6eef8;
    }
    
    .splash-loading {
      margin: 50px 0 30px 0;
      animation: loadingFadeIn 0.5s ease-out 1s both;
    }
    
    .loading-text {
      font-size: 18px;
      color: #98a0b3;
      margin-bottom: 20px;
      font-weight: 500;
    }
    
    .loading-bar {
      width: 300px;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      margin: 0 auto 15px auto;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .loading-progress {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #1fb6ff, #00d2ff, #1fb6ff);
      background-size: 200% 100%;
      border-radius: 3px;
      animation: progressFlow 2s ease-in-out infinite;
      transition: width 0.3s ease;
      box-shadow: 0 0 10px rgba(31, 182, 255, 0.5);
    }
    
    .loading-percentage {
      font-size: 14px;
      color: #1fb6ff;
      font-weight: 700;
    }
    
    .splash-credits {
      animation: creditsFadeIn 0.5s ease-out 1.5s both;
    }
    
    .credits-text {
      font-size: 14px;
      color: #98a0b3;
      margin-bottom: 8px;
    }
    
    .credits-company {
      font-size: 16px;
      color: #1fb6ff;
      font-weight: 700;
      text-shadow: 0 2px 10px rgba(31, 182, 255, 0.3);
    }
    
    .splash-particles {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      z-index: 1;
    }
    
    .particle {
      position: absolute;
      width: 3px;
      height: 3px;
      background: rgba(31, 182, 255, 0.6);
      border-radius: 50%;
      animation: particleFloat 10s linear infinite;
    }
    
    @keyframes splashFadeIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes splashPulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }
    
    @keyframes gradientShift {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }
    
    @keyframes featureSlideIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes loadingFadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes creditsFadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    
    @keyframes progressFlow {
      0% {
        background-position: -200% 0;
      }
      100% {
        background-position: 200% 0;
      }
    }
    
    @keyframes particleFloat {
      0% {
        transform: translateY(100vh) scale(0);
        opacity: 0;
      }
      10% {
        opacity: 1;
        transform: scale(1);
      }
      90% {
        opacity: 1;
      }
      100% {
        transform: translateY(-100vh) scale(0);
        opacity: 0;
      }
    }
    
    /* Mobile responsive adjustments */
    @media (max-width: 768px) {
      .splash-content {
        padding: 20px;
        max-width: 90%;
      }
      
      .logo-icon {
        font-size: 60px;
      }
      
      .logo-title {
        font-size: 32px;
      }
      
      .logo-subtitle {
        font-size: 16px;
      }
      
      .splash-features {
        grid-template-columns: 1fr;
        gap: 15px;
        margin: 30px 0;
      }
      
      .feature {
        padding: 12px 16px;
      }
      
      .loading-bar {
        width: 250px;
      }
    }
    
    /* Hide main content initially */
    .app {
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.5s ease;
    }
    
    .app.loaded {
      opacity: 1;
      visibility: visible;
    }
    
    .layout-toggle {
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.5s ease;
    }
    
    .layout-toggle.loaded {
      opacity: 1;
      visibility: visible;
    }
    
    /* Rhythm Patches */
    .rhythm-patches{
      background:rgba(0,0,0,0.2);
      border-radius:12px;
      margin:16px 0;
      overflow:hidden;
      border:1px solid rgba(255,255,255,0.1);
    }
    
    .patch-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 16px;
      background:rgba(255,255,255,0.05);
      cursor:pointer;
      transition:all 0.2s ease;
    }
    
    .patch-header:hover{
      background:rgba(255,255,255,0.08);
    }
    
    .patch-title{
      font-size:14px;
      font-weight:600;
      color:var(--accent);
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    
    .patch-toggle{
      background:none;
      border:none;
      color:var(--accent);
      font-size:14px;
      cursor:pointer;
      transition:transform 0.2s ease;
    }
    
    .patch-toggle.collapsed{
      transform:rotate(-90deg);
    }
    
    .patch-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(100px, 1fr));
      gap:8px;
      padding:12px;
      max-height:200px;
      transition:all 0.3s ease;
      overflow:hidden;
    }
    
    .patch-grid.collapsed{
      max-height:0;
      padding:0 16px;
    }
    
    .patch-btn{
      background:linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      border:2px solid rgba(255,255,255,0.15);
      border-radius:8px;
      padding:8px 6px;
      cursor:pointer;
      text-align:center;
      transition:all 0.2s ease;
      color:#fff;
      position:relative;
      overflow:hidden;
    }
    
    .patch-btn:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 25px rgba(0,0,0,0.3);
    }
    
    .patch-btn:active{
      transform:translateY(0);
    }
    
    .patch-btn.active{
      border-color:var(--accent);
      background:linear-gradient(135deg, rgba(31,182,255,0.2), rgba(31,182,255,0.1));
      box-shadow:0 0 20px rgba(31,182,255,0.4);
    }
    
    .patch-icon{
      font-size:18px;
      margin-bottom:4px;
    }
    
    .patch-name{
      font-size:10px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.5px;
      margin-bottom:2px;
    }
    
    .patch-bpm{
      font-size:9px;
      color:var(--muted);
      font-weight:500;
    }
    
    /* Genre-specific colors */
    .funk-patch:hover{ border-color:#ff6b6b; background:linear-gradient(135deg, rgba(255,107,107,0.2), rgba(255,107,107,0.1)); }
    .rock-patch:hover{ border-color:#ffa500; background:linear-gradient(135deg, rgba(255,165,0,0.2), rgba(255,165,0,0.1)); }
    .pop-patch:hover{ border-color:#ff69b4; background:linear-gradient(135deg, rgba(255,105,180,0.2), rgba(255,105,180,0.1)); }
    .trap-patch:hover{ border-color:#9b59b6; background:linear-gradient(135deg, rgba(155,89,182,0.2), rgba(155,89,182,0.1)); }
    .house-patch:hover{ border-color:#00d2ff; background:linear-gradient(135deg, rgba(0,210,255,0.2), rgba(0,210,255,0.1)); }
    .reggae-patch:hover{ border-color:#2ed573; background:linear-gradient(135deg, rgba(46,213,115,0.2), rgba(46,213,115,0.1)); }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .app {
        display: block;
        padding: 12px;
        border-spacing: 0;
      }
      .app-row {
        display: block;
      }
      .card-column {
        display: block;
        width: 100%;
        margin-bottom: 15px;
        border-right: none;
      }
      .card-column::after {
        display: none;
      }
      .card { padding: 16px; }
      .card-title { font-size: 18px; }
      .section-title { font-size: 14px; }
      .timeline-container { padding: 12px; }
      .seq-controls { gap: 6px; }
      .seq-btn { padding: 6px 10px; font-size: 11px; }
      #xyCanvas { height: 300px; }
      .card-btn { width: 24px; height: 24px; font-size: 12px; }
      .patch-grid { grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); }
      .patch-btn { padding: 6px 4px; }
      .patch-icon { font-size: 16px; }
    }

    /* Controles de redimensionamento de colunas */
    .column-resizer {
      position: absolute;
      top: 0;
      right: -6px;
      width: 12px;
      height: 100%;
      cursor: col-resize;
      background: transparent;
      z-index: 1001;
      user-select: none;
    }

    .column-resizer:hover {
      background: rgba(31,182,255,0.3);
    }

    .column-resizer.dragging {
      background: rgba(31,182,255,0.6);
    }
    
    /* Controles de Patch XY */
    .xy-patch-controls {
      margin: 20px 0;
      padding: 16px;
      background: rgba(0,0,0,0.15);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.08);
    }
    
    .patch-controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .patch-control-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 12px;
      background: rgba(255,255,255,0.02);
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.05);
    }
    
    .control-value {
      font-size: 11px;
      color: var(--accent);
      font-weight: 700;
      min-width: 50px;
      text-align: right;
    }
    
    .xy-coordinates {
      font-size: 13px;
      color: var(--accent);
      font-weight: 600;
      font-family: 'Courier New', monospace;
    }
    
    .coordinate-display {
      background: rgba(31,182,255,0.1);
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid rgba(31,182,255,0.2);
    }
    
    /* Presets de Patch */
    .patch-presets {
      margin-top: 16px;
    }
    
    .patch-preset-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 8px;
      margin-top: 12px;
    }
    
    .patch-preset-btn {
      background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 8px;
      padding: 10px 8px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s ease;
      color: #fff;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .patch-preset-btn:hover {
      transform: translateY(-2px);
      border-color: var(--accent);
      background: rgba(31,182,255,0.1);
      box-shadow: 0 4px 15px rgba(31,182,255,0.3);
    }
    
    .patch-preset-btn:active {
      transform: translateY(0);
    }
    
    .patch-preset-btn.active {
      border-color: var(--accent);
      background: linear-gradient(135deg, rgba(31,182,255,0.2), rgba(31,182,255,0.1));
      box-shadow: 0 0 20px rgba(31,182,255,0.4);
    }
  </style>
</head>
<body>
  <!-- Splash Screen -->
  <div id="splashScreen" class="splash-screen">
    <div class="splash-content">
      <div class="splash-logo">
        <div class="logo-icon">üéõÔ∏è</div>
        <div class="logo-text">
          <div class="logo-title">SynthBat Studio</div>
          <div class="logo-subtitle">Sintetizador e Sequenciador Musical</div>
        </div>
      </div>
      
      <div class="splash-features">
        <div class="feature">
          <span class="feature-icon">ü•Å</span>
          <span class="feature-text">16 Pads de Bateria</span>
        </div>
        <div class="feature">
          <span class="feature-icon">üéπ</span>
          <span class="feature-text">Sintetizador Completo</span>
        </div>
        <div class="feature">
          <span class="feature-icon">üéµ</span>
          <span class="feature-text">Sequenciador 32 Steps</span>
        </div>
        <div class="feature">
          <span class="feature-icon">üéº</span>
          <span class="feature-text">Patches de Ritmo</span>
        </div>
      </div>
      
      <div class="splash-loading">
        <div class="loading-text">Carregando...</div>
        <div class="loading-bar">
          <div class="loading-progress" id="loadingProgress"></div>
        </div>
        <div class="loading-percentage" id="loadingPercentage">0%</div>
      </div>
      
      <div class="splash-credits">
        <div class="credits-text">Desenvolvido por Julio Campos Machado</div>
        <div class="credits-company">Like Look Solutions</div>
      </div>
    </div>
    
    <div class="splash-particles" id="splashParticles">
      <!-- Particles will be generated by JavaScript -->
    </div>
  </div>

  <!-- Layout Toggle Button -->
  <button class="layout-toggle" id="layoutToggle">üìã LINHA √öNICA</button>
  
  <div class="app" id="appContainer">
    <div class="app-row">
      <!-- Coluna 1: Controles -->
      <div class="card-column" id="column1">
        <div class="column-resizer" data-column="1"></div>
        <div class="card-container controls">
          <div class="card" id="controlsCard" draggable="true">
        <div class="card-header">
          <div>
            <h1 class="card-title">üéµ SynthBat Studio</h1>
            <p class="card-subtitle">Sintetizador e Sequenciador Musical</p>
          </div>
          <div class="card-controls">
            <div class="card-btn collapse-btn" title="Recolher/Expandir" data-card="controlsCard">‚àí</div>
            <div class="card-btn" title="Arrastar para reorganizar">‚ãÆ‚ãÆ</div>
          </div>
        </div>
        <div class="card-content">

      <!-- Drum Pads Section -->
      <div class="section">
        <div class="section-title">ü•Å Bateria</div>
        <table class="pads-table">
          <tr>
            <td><div class="pad pad-kick" data-pad="kick">KICK</div></td>
            <td><div class="pad pad-snare" data-pad="snare">SNARE</div></td>
            <td><div class="pad pad-hat" data-pad="hat">HI-HAT</div></td>
          </tr>
          <tr>
            <td><div class="pad pad-openhat" data-pad="openhat">OPEN HAT</div></td>
            <td><div class="pad pad-crash" data-pad="crash">CRASH</div></td>
            <td><div class="pad pad-ride" data-pad="ride">RIDE</div></td>
          </tr>
          <tr>
            <td><div class="pad pad-tom" data-pad="tom">TOM</div></td>
            <td><div class="pad pad-clap" data-pad="clap">CLAP</div></td>
            <td><div class="pad pad-perc" data-pad="perc">PERC</div></td>
          </tr>
        </table>
      </div>
      
      <!-- Piano & Keyboard Section -->
      <div class="section">
        <div class="section-title">üéπ Piano & Teclados</div>
        <table class="pads-table">
          <tr>
            <td><div class="pad pad-piano" data-pad="piano">PIANO</div></td>
            <td><div class="pad pad-epiano" data-pad="epiano">E.PIANO</div></td>
            <td><div class="pad pad-grandpiano" data-pad="grandpiano">GRAND</div></td>
          </tr>
          <tr>
            <td><div class="pad pad-harpsichord" data-pad="harpsichord">HARPSI</div></td>
            <td><div class="pad pad-ragtime" data-pad="ragtime">RAGTIME</div></td>
            <td><div class="pad pad-musicbox" data-pad="musicbox">MUSIC BOX</div></td>
          </tr>
        </table>
      </div>
      
      <!-- Organs & Keys Section -->
      <div class="section">
        <div class="section-title">üéº √ìrg√£os & Teclas</div>
        <table class="pads-table">
          <tr>
            <td><div class="pad pad-organ" data-pad="organ">ORGAN</div></td>
            <td><div class="pad pad-hammond" data-pad="hammond">HAMMOND</div></td>
            <td><div class="pad pad-church" data-pad="church">CHURCH</div></td>
          </tr>
          <tr>
            <td><div class="pad pad-accordion" data-pad="accordion">ACCORD</div></td>
            <td><div class="pad pad-harmonica" data-pad="harmonica">HARMON</div></td>
            <td><div class="pad pad-concertina" data-pad="concertina">CONCERT</div></td>
          </tr>
        </table>
      </div>
      
      <!-- Synthesizers Section -->
      <div class="section">
        <div class="section-title">üéõÔ∏è Sintetizadores</div>
        <table class="pads-table">
          <tr>
            <td><div class="pad pad-lead" data-pad="lead">LEAD</div></td>
            <td><div class="pad pad-bass" data-pad="bass">BASS</div></td>
            <td><div class="pad pad-pad" data-pad="synthpad">PAD</div></td>
          </tr>
          <tr>
            <td><div class="pad pad-pluck" data-pad="pluck">PLUCK</div></td>
            <td><div class="pad pad-arp" data-pad="arp">ARP</div></td>
            <td><div class="pad pad-sequence" data-pad="sequence">SEQUENCE</div></td>
          </tr>
          <tr>
            <td><div class="pad pad-polysynth" data-pad="polysynth">POLY</div></td>
            <td><div class="pad pad-monosynth" data-pad="monosynth">MONO</div></td>
            <td><div class="pad pad-fm" data-pad="fm">FM</div></td>
          </tr>
        </table>
      </div>
      
      <!-- Strings Section -->
      <div class="section">
        <div class="section-title">üéª Cordas</div>
        <table class="pads-table">
          <tr>
            <td><div class="pad pad-violin" data-pad="violin">VIOLIN</div></td>
            <td><div class="pad pad-viola" data-pad="viola">VIOLA</div></td>
            <td><div class="pad pad-cello" data-pad="cello">CELLO</div></td>
          </tr>
          <tr>
            <td><div class="pad pad-contrabass" data-pad="contrabass">CONTRA</div></td>
            <td><div class="pad pad-strings" data-pad="strings">STRINGS</div></td>
            <td><div class="pad pad-pizzicato" data-pad="pizzicato">PIZZ</div></td>
          </tr>
        </table>
      </div>
      
      <!-- Guitars Section -->
      <div class="section">
        <div class="section-title">üé∏ Guitarras</div>
        <table class="pads-table">
          <tr>
            <td><div class="pad pad-acoustic" data-pad="acoustic">ACOUSTIC</div></td>
            <td><div class="pad pad-electric" data-pad="electric">ELECTRIC</div></td>
            <td><div class="pad pad-distorted" data-pad="distorted">DISTORT</div></td>
          </tr>
          <tr>
            <td><div class="pad pad-clean" data-pad="clean">CLEAN</div></td>
            <td><div class="pad pad-muted" data-pad="muted">MUTED</div></td>
            <td><div class="pad pad-overdrive" data-pad="overdrive">OVERDRIVE</div></td>
          </tr>
        </table>
      </div>
      
      <!-- Wind Instruments Section -->
      <div class="section">
        <div class="section-title">üé∫ Sopros</div>
        <table class="pads-table">
          <tr>
            <td><div class="pad pad-trumpet" data-pad="trumpet">TRUMPET</div></td>
            <td><div class="pad pad-trombone" data-pad="trombone">TROMBONE</div></td>
            <td><div class="pad pad-horn" data-pad="horn">HORN</div></td>
          </tr>
          <tr>
            <td><div class="pad pad-tuba" data-pad="tuba">TUBA</div></td>
            <td><div class="pad pad-saxophone" data-pad="saxophone">SAX</div></td>
            <td><div class="pad pad-flute" data-pad="flute">FLUTE</div></td>
          </tr>
          <tr>
            <td><div class="pad pad-clarinet" data-pad="clarinet">CLARINET</div></td>
            <td><div class="pad pad-oboe" data-pad="oboe">OBOE</div></td>
            <td><div class="pad pad-bassoon" data-pad="bassoon">BASSOON</div></td>
          </tr>
        </table>
      </div>
      
      <!-- Effects Section -->
      <div class="section">
        <div class="section-title">üéõÔ∏è Efeitos</div>
        <table class="pads-table">
          <tr>
            <td><div class="pad pad-fx" data-pad="reverse">REVERSE</div></td>
            <td><div class="pad pad-sweep" data-pad="sweep">SWEEP</div></td>
            <td><div class="pad pad-noise" data-pad="whitenoise">NOISE</div></td>
          </tr>
        </table>
      </div>
      
      <!-- Controls Section -->
      <div class="section">
        <div class="section-title">‚öôÔ∏è Controles Globais</div>
        <div class="controls-grid">
          <div class="control-group">
            <div class="control-row">
              <span class="control-label">BPM</span>
              <input id="bpm" type="range" min="40" max="200" value="100" />
            </div>
            <div class="control-row">
              <span class="control-label">Volume</span>
              <input id="masterVol" type="range" min="0" max="1" step="0.01" value="0.9" />
            </div>
            <div class="control-row">
              <span class="control-label">Pitch</span>
              <input id="pitchRange" type="range" min="0.2" max="3" step="0.01" value="1.5" />
            </div>
          </div>
          <div class="control-group">
            <div class="btn-group">
              <button id="startStop" class="btn">Start</button>
              <button id="metroToggle" class="btn muted">Metr√¥nomo</button>
              <button id="savePreset" class="btn muted">Salvar Preset</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Presets Section -->
      <div class="section">
        <div class="section-title">üíæ Presets</div>
        <div class="preset-grid" id="presets"></div>
        </div>
      </div>
          </div>
        </div>
      </div>

      <!-- Coluna 2: XY Pad -->
      <div class="card-column" id="column2">
        <div class="column-resizer" data-column="2"></div>
        <div class="card-container main">
          <div class="card" id="xyCard" draggable="true">
        <div class="card-header">
          <div>
            <h2 class="card-title">üéöÔ∏è Controle XY</h2>
            <p class="card-subtitle">√Årea de controle em tempo real</p>
          </div>
          <div class="card-controls">
            <div class="card-btn collapse-btn" title="Recolher/Expandir" data-card="xyCard">‚àí</div>
            <div class="card-btn pin-btn" title="Fixar/Desfixar Card" data-card="xyCard">üìå</div>
            <div class="card-btn" title="Arrastar para reorganizar">‚ãÆ‚ãÆ</div>
          </div>
        </div>
        <div class="card-content">
        
        <canvas id="xyCanvas"></canvas>
        
        <!-- Controles de Patch XY -->
        <div class="xy-patch-controls">
          <div class="section-title">üéõÔ∏è Par√¢metros do Patch</div>
          
          <div class="patch-controls-grid">
            <div class="patch-control-group">
              <div class="control-row">
                <span class="control-label">Modo:</span>
                <select id="mode">
                  <option value="sampleBlend">Misturar Samples</option>
                  <option value="oscillator">Oscilador</option>
                  <option value="drumMorph">Morph Bateria</option>
                  <option value="granular">Granular</option>
                </select>
              </div>
              
              <div class="control-row">
                <span class="control-label">Tonalidade:</span>
                <select id="keySelect">
                  <option value="C">D√≥ (C)</option>
                  <option value="Db">D√≥# (Db)</option>
                  <option value="D">R√© (D)</option>
                  <option value="Eb">R√©# (Eb)</option>
                  <option value="E">Mi (E)</option>
                  <option value="F">F√° (F)</option>
                  <option value="Gb">F√°# (Gb)</option>
                  <option value="G">Sol (G)</option>
                  <option value="Ab">Sol# (Ab)</option>
                  <option value="A">L√° (A)</option>
                  <option value="Bb">L√°# (Bb)</option>
                  <option value="B">Si (B)</option>
                </select>
              </div>
              
              <div class="control-row">
                <span class="control-label">Escala:</span>
                <select id="scaleSelect">
                  <option value="major">Maior</option>
                  <option value="minor">Menor</option>
                  <option value="pentatonic">Pentat√¥nica</option>
                  <option value="blues">Blues</option>
                  <option value="chromatic">Crom√°tica</option>
                </select>
              </div>
            </div>
            
            <div class="patch-control-group">
              <div class="control-row">
                <span class="control-label">Velocidade:</span>
                <input id="velocityRange" type="range" min="0.1" max="2" step="0.1" value="1" />
                <span class="control-value" id="velocityValue">1.0</span>
              </div>
              
              <div class="control-row">
                <span class="control-label">Reverb:</span>
                <input id="reverbAmount" type="range" min="0" max="100" value="30" />
                <span class="control-value" id="reverbValue">30%</span>
              </div>
              
              <div class="control-row">
                <span class="control-label">Delay:</span>
                <input id="delayAmount" type="range" min="0" max="100" value="0" />
                <span class="control-value" id="delayValue">0%</span>
              </div>
            </div>
            
            <div class="patch-control-group">
              <div class="control-row">
                <span class="control-label">Distor√ß√£o:</span>
                <input id="distortionAmount" type="range" min="0" max="100" value="0" />
                <span class="control-value" id="distortionValue">0%</span>
              </div>
              
              <div class="control-row">
                <span class="control-label">Filtro LP:</span>
                <input id="lowpassFreq" type="range" min="100" max="8000" value="4000" />
                <span class="control-value" id="lowpassValue">4000Hz</span>
              </div>
              
              <div class="control-row">
                <span class="control-label">Reson√¢ncia:</span>
                <input id="resonanceAmount" type="range" min="1" max="30" value="1" />
                <span class="control-value" id="resonanceValue">1.0</span>
              </div>
            </div>
          </div>
          
          <!-- Presets de Patch -->
          <div class="patch-presets">
            <div class="section-title">üé® Presets de Patch</div>
            <div class="patch-preset-grid">
              <button class="patch-preset-btn" data-preset="lead">üé∫ Lead</button>
              <button class="patch-preset-btn" data-preset="bass">üé∏ Bass</button>
              <button class="patch-preset-btn" data-preset="pad">üåä Pad</button>
              <button class="patch-preset-btn" data-preset="pluck">üéµ Pluck</button>
              <button class="patch-preset-btn" data-preset="ambient">üåå Ambient</button>
              <button class="patch-preset-btn" data-preset="aggressive">üî• Aggressive</button>
            </div>
          </div>
        </div>
        
        <div class="xy-info">
          <div class="meta">Eixo X: varia√ß√£o entre timbres e filtros ‚Ä¢ Eixo Y: pitch, volume e modula√ß√£o</div>
          <div class="xy-coordinates">
            <span class="coordinate-display">X: <span id="xCoord">0.0</span> | Y: <span id="yCoord">0.0</span></span>
          </div>
        </div>
      </div>
          </div>
        </div>
      </div>
      
      <!-- Coluna 3: Sequenciador -->
      <div class="card-column" id="column3">
        <div class="card-container main">
          <div class="card" id="sequencerCard" draggable="true">
        <div class="card-header">
          <div>
            <h2 class="card-title">üéµ Sequenciador</h2>
            <p class="card-subtitle">32 Steps ‚Ä¢ 8 Trilhas</p>
          </div>
          <div class="card-controls">
            <div class="card-btn collapse-btn" title="Recolher/Expandir" data-card="sequencerCard">‚àí</div>
            <div class="card-btn" title="Arrastar para reorganizar">‚ãÆ‚ãÆ</div>
          </div>
        </div>
        <div class="card-content">
        
        <div class="seq-controls">
          <button id="seqPlay" class="seq-btn">‚ñ∂ PLAY</button>
          <button id="seqStop" class="seq-btn danger">‚èπ STOP</button>
          <button id="seqRecord" class="seq-btn success">‚è∫ GRAVAR</button>
          <button id="seqClear" class="seq-btn">üóë LIMPAR</button>
          <button id="seqSave" class="seq-btn">üíæ SALVAR</button>
          <button id="seqLoad" class="seq-btn">üìÅ CARREGAR</button>
          
          <div class="bpm-control">
            <span class="bpm-display">Tempo: <span id="seqBpm">120</span> BPM</span>
            <input id="seqBpmSlider" type="range" min="60" max="180" value="120">
          </div>
        </div>
        
        <!-- Rhythm Patches -->
        <div class="rhythm-patches">
          <div class="patch-header">
            <span class="patch-title">üéº Patches de Ritmo</span>
            <button id="patchesToggle" class="patch-toggle">‚ñº</button>
          </div>
          <div class="patch-grid" id="patchGrid">
            <button class="patch-btn funk-patch" data-patch="funk">
              <div class="patch-icon">üé∏</div>
              <div class="patch-name">FUNK</div>
              <div class="patch-bpm">110 BPM</div>
            </button>
            <button class="patch-btn rock-patch" data-patch="rock">
              <div class="patch-icon">ü§ò</div>
              <div class="patch-name">ROCK</div>
              <div class="patch-bpm">140 BPM</div>
            </button>
            <button class="patch-btn pop-patch" data-patch="pop">
              <div class="patch-icon">‚≠ê</div>
              <div class="patch-name">POP</div>
              <div class="patch-bpm">128 BPM</div>
            </button>
            <button class="patch-btn trap-patch" data-patch="trap">
              <div class="patch-icon">üíé</div>
              <div class="patch-name">TRAP</div>
              <div class="patch-bpm">140 BPM</div>
            </button>
            <button class="patch-btn house-patch" data-patch="house">
              <div class="patch-icon">üéõÔ∏è</div>
              <div class="patch-name">HOUSE</div>
              <div class="patch-bpm">124 BPM</div>
            </button>
            <button class="patch-btn reggae-patch" data-patch="reggae">
              <div class="patch-icon">üå¥</div>
              <div class="patch-name">REGGAE</div>
              <div class="patch-bpm">90 BPM</div>
            </button>
          </div>
        </div>
        
        <div class="sequencer-container">
          <div class="sequencer-grid">
            <table class="sequencer-table" id="sequencerTable">
              <!-- Tabela ser√° gerada dinamicamente -->
            </table>
            <div class="playhead" id="playhead"></div>
          </div>
        </div>
        
        <div class="meta" style="margin-top:12px;">
          üí° Dica: Clique nos pads em modo GRAVAR para adicionar √† trilha, ou clique diretamente nas c√©lulas para programar beats
        </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- UI Helper Elements -->
    <div class="drop-hint" id="dropHint">üìç Solte aqui para reorganizar</div>
    <div class="layout-indicator" id="layoutIndicator">Layout salvo automaticamente! ‚ú®</div>
  </div>

<script>
// --- Setup WebAudio ---
const AudioContext = window.AudioContext || window.webkitAudioContext;
const ctx = new AudioContext();
let masterGain = ctx.createGain(); masterGain.gain.value = 0.9; masterGain.connect(ctx.destination);

// Basic utilities
function now(){return ctx.currentTime}

// State
const state = {
  bpm:100, playing:false, metro:false,
  pitchRange:1.5, masterVol:0.9,
  mode:'sampleBlend'
}

// Sequencer state
const sequencer = {
  bpm: 120,
  playing: false,
  recording: false,
  currentStep: 0,
  steps: 32,
  tracks: [
    {name: 'KICK', sound: 'kick', pattern: new Array(32).fill(false)},
    {name: 'SNARE', sound: 'snare', pattern: new Array(32).fill(false)},
    {name: 'HAT', sound: 'hat', pattern: new Array(32).fill(false)},
    {name: 'OPEN HAT', sound: 'openhat', pattern: new Array(32).fill(false)},
    {name: 'CRASH', sound: 'crash', pattern: new Array(32).fill(false)},
    {name: 'PIANO', sound: 'piano', pattern: new Array(32).fill(false)},
    {name: 'BASS', sound: 'bass', pattern: new Array(32).fill(false)},
    {name: 'LEAD', sound: 'lead', pattern: new Array(32).fill(false)}
  ],
  interval: null,
  audioRecorder: null,
  recordedChunks: [],
  mediaRecorder: null
}

// Wire controls
const bpmSlider = document.getElementById('bpm');
const masterVol = document.getElementById('masterVol');
const pitchRange = document.getElementById('pitchRange');
const startStopBtn = document.getElementById('startStop');
const metroToggle = document.getElementById('metroToggle');
const xyCanvas = document.getElementById('xyCanvas');
const modeSel = document.getElementById('mode');

bpmSlider.addEventListener('input',()=>{state.bpm=+bpmSlider.value});
masterVol.addEventListener('input',()=>{state.masterVol=+masterVol.value; masterGain.gain.setValueAtTime(state.masterVol, now());});
pitchRange.addEventListener('input',()=>{state.pitchRange=+pitchRange.value});
modeSel.addEventListener('change',()=>{state.mode=modeSel.value; drawGuide();});

// Sequencer controls
const seqBpmSlider = document.getElementById('seqBpmSlider');
const seqBpmDisplay = document.getElementById('seqBpm');
const seqPlayBtn = document.getElementById('seqPlay');
const seqStopBtn = document.getElementById('seqStop');
const seqRecordBtn = document.getElementById('seqRecord');
const seqClearBtn = document.getElementById('seqClear');
const seqSaveBtn = document.getElementById('seqSave');
const seqLoadBtn = document.getElementById('seqLoad');

seqBpmSlider.addEventListener('input', () => {
  sequencer.bpm = +seqBpmSlider.value;
  seqBpmDisplay.textContent = sequencer.bpm;
});

seqPlayBtn.addEventListener('click', () => sequencer.playing ? stopSequencer() : startSequencer());
seqStopBtn.addEventListener('click', stopSequencer);
seqRecordBtn.addEventListener('click', toggleRecording);
seqClearBtn.addEventListener('click', clearSequencer);
seqSaveBtn.addEventListener('click', saveSequence);
seqLoadBtn.addEventListener('click', loadSequence);

startStopBtn.addEventListener('click',()=>{ if(!state.playing){ startTransport(); } else { stopTransport(); } });
metroToggle.addEventListener('click',()=>{ state.metro = !state.metro; metroToggle.style.opacity = state.metro?1:0.6; });

// --- Drum pads synthesis ---
function playKick(time){
  const g = ctx.createGain(); g.gain.value = 1; g.connect(masterGain);
  const o = ctx.createOscillator(); o.type='sine'; o.frequency.setValueAtTime(150, time);
  o.frequency.exponentialRampToValueAtTime(40, time+0.5);
  g.gain.setValueAtTime(0.0001, time);
  g.gain.exponentialRampToValueAtTime(1.2, time+0.001);
  g.gain.exponentialRampToValueAtTime(0.001, time+0.6);
  o.connect(g); o.start(time); o.stop(time+0.7);
}

function playSnare(time){
  const noise = ctx.createBufferSource();
  noise.buffer = makeNoiseBuffer();
  const nFilter = ctx.createBiquadFilter(); nFilter.type='highpass'; nFilter.frequency.value = 1000;
  const g = ctx.createGain(); g.gain.value=1; g.connect(masterGain);
  noise.connect(nFilter); nFilter.connect(g);
  g.gain.setValueAtTime(1, time); g.gain.exponentialRampToValueAtTime(0.01, time+0.4);
  noise.start(time); noise.stop(time+0.5);
}

function playHat(time){
  const o = ctx.createOscillator(); o.type='square'; o.frequency.value=8000;
  const g = ctx.createGain(); g.gain.value=0.0001; g.connect(masterGain);
  o.connect(g); o.start(time);
  g.gain.setValueAtTime(0.0001, time); g.gain.exponentialRampToValueAtTime(0.6, time+0.001); g.gain.exponentialRampToValueAtTime(0.0001, time+0.12);
  o.stop(time+0.15);
}

function playOpenHat(time){
  const o = ctx.createOscillator(); o.type='square'; o.frequency.value=7000;
  const g = ctx.createGain(); g.gain.value=0.0001; g.connect(masterGain);
  o.connect(g); o.start(time);
  g.gain.setValueAtTime(0.0001, time); g.gain.exponentialRampToValueAtTime(0.4, time+0.001); g.gain.exponentialRampToValueAtTime(0.0001, time+0.3);
  o.stop(time+0.35);
}

function playCrash(time){
  const noise = ctx.createBufferSource();
  noise.buffer = makeNoiseBuffer();
  const filter = ctx.createBiquadFilter(); filter.type='highpass'; filter.frequency.value = 3000;
  const g = ctx.createGain(); g.gain.value=0.8; g.connect(masterGain);
  noise.connect(filter); filter.connect(g);
  g.gain.setValueAtTime(0.8, time); g.gain.exponentialRampToValueAtTime(0.001, time+2.0);
  noise.start(time); noise.stop(time+2.5);
}

function playRide(time){
  const o1 = ctx.createOscillator(); o1.type='triangle'; o1.frequency.value=4000;
  const o2 = ctx.createOscillator(); o2.type='sine'; o2.frequency.value=8000;
  const g = ctx.createGain(); g.gain.value=0.0001; g.connect(masterGain);
  o1.connect(g); o2.connect(g); o1.start(time); o2.start(time);
  g.gain.setValueAtTime(0.0001, time); g.gain.exponentialRampToValueAtTime(0.3, time+0.001); g.gain.exponentialRampToValueAtTime(0.0001, time+0.8);
  o1.stop(time+0.9); o2.stop(time+0.9);
}

function playTom(time){
  const o = ctx.createOscillator(); o.type='sine'; o.frequency.setValueAtTime(220, time); o.frequency.exponentialRampToValueAtTime(120, time+0.4);
  const g = ctx.createGain(); g.gain.value=1; g.connect(masterGain);
  g.gain.setValueAtTime(1, time); g.gain.exponentialRampToValueAtTime(0.001, time+0.6);
  o.connect(g); o.start(time); o.stop(time+0.8);
}

function playClap(time){
  // Multiple quick noise bursts to simulate clap
  for(let i = 0; i < 4; i++) {
    const noise = ctx.createBufferSource();
    noise.buffer = makeNoiseBuffer();
    const filter = ctx.createBiquadFilter(); filter.type='bandpass'; filter.frequency.value = 1500;
    const g = ctx.createGain(); g.gain.value=0.3; g.connect(masterGain);
    noise.connect(filter); filter.connect(g);
    const startTime = time + i * 0.01;
    g.gain.setValueAtTime(0.3, startTime); g.gain.exponentialRampToValueAtTime(0.001, startTime+0.1);
    noise.start(startTime); noise.stop(startTime+0.12);
  }
}

function playPerc(time){
  const o = ctx.createOscillator(); o.type='triangle'; o.frequency.setValueAtTime(800, time); o.frequency.exponentialRampToValueAtTime(200, time+0.2);
  const g = ctx.createGain(); g.gain.value=0.6; g.connect(masterGain);
  g.gain.setValueAtTime(0.6, time); g.gain.exponentialRampToValueAtTime(0.001, time+0.3);
  o.connect(g); o.start(time); o.stop(time+0.4);
}

// --- Melodic instruments ---
function playPiano(time, freq = 440){
  // Simple piano-like sound with multiple harmonics
  const o1 = ctx.createOscillator(); o1.type='sine'; o1.frequency.value=freq;
  const o2 = ctx.createOscillator(); o2.type='sine'; o2.frequency.value=freq*2;
  const o3 = ctx.createOscillator(); o3.type='sine'; o3.frequency.value=freq*3;
  const g1 = ctx.createGain(); g1.gain.value=0.6;
  const g2 = ctx.createGain(); g2.gain.value=0.3;
  const g3 = ctx.createGain(); g3.gain.value=0.1;
  const master = ctx.createGain(); master.connect(masterGain);
  o1.connect(g1); o2.connect(g2); o3.connect(g3);
  g1.connect(master); g2.connect(master); g3.connect(master);
  master.gain.setValueAtTime(0.7, time); master.gain.exponentialRampToValueAtTime(0.001, time+2.0);
  o1.start(time); o2.start(time); o3.start(time);
  o1.stop(time+2.5); o2.stop(time+2.5); o3.stop(time+2.5);
}

function playBass(time, freq = 110){
  const o = ctx.createOscillator(); o.type='sawtooth'; o.frequency.value=freq;
  const filter = ctx.createBiquadFilter(); filter.type='lowpass'; filter.frequency.value=800;
  const g = ctx.createGain(); g.gain.value=0.8; g.connect(masterGain);
  o.connect(filter); filter.connect(g);
  g.gain.setValueAtTime(0.8, time); g.gain.exponentialRampToValueAtTime(0.001, time+1.2);
  o.start(time); o.stop(time+1.5);
}

function playLead(time, freq = 880){
  const o = ctx.createOscillator(); o.type='sawtooth'; o.frequency.value=freq;
  const filter = ctx.createBiquadFilter(); filter.type='lowpass'; filter.frequency.value=3000;
  const g = ctx.createGain(); g.gain.value=0.6; g.connect(masterGain);
  o.connect(filter); filter.connect(g);
  g.gain.setValueAtTime(0.6, time); g.gain.exponentialRampToValueAtTime(0.001, time+1.5);
  o.start(time); o.stop(time+2.0);
}

function playSynthPad(time, freq = 220){
  const o1 = ctx.createOscillator(); o1.type='sawtooth'; o1.frequency.value=freq;
  const o2 = ctx.createOscillator(); o2.type='sawtooth'; o2.frequency.value=freq*1.5;
  const filter = ctx.createBiquadFilter(); filter.type='lowpass'; filter.frequency.value=1500;
  const g = ctx.createGain(); g.gain.value=0.4; g.connect(masterGain);
  o1.connect(filter); o2.connect(filter); filter.connect(g);
  g.gain.setValueAtTime(0.001, time); g.gain.exponentialRampToValueAtTime(0.4, time+0.3); g.gain.exponentialRampToValueAtTime(0.001, time+3.0);
  o1.start(time); o2.start(time); o1.stop(time+3.5); o2.stop(time+3.5);
}

function playPluck(time, freq = 440){
  const o = ctx.createOscillator(); o.type='triangle'; o.frequency.value=freq;
  const g = ctx.createGain(); g.gain.value=0.7; g.connect(masterGain);
  o.connect(g);
  g.gain.setValueAtTime(0.7, time); g.gain.exponentialRampToValueAtTime(0.001, time+0.8);
  o.start(time); o.stop(time+1.0);
}

function playOrgan(time, freq = 330){
  const o1 = ctx.createOscillator(); o1.type='sine'; o1.frequency.value=freq;
  const o2 = ctx.createOscillator(); o2.type='sine'; o2.frequency.value=freq*2;
  const o3 = ctx.createOscillator(); o3.type='sine'; o3.frequency.value=freq*3;
  const g = ctx.createGain(); g.gain.value=0.5; g.connect(masterGain);
  o1.connect(g); o2.connect(g); o3.connect(g);
  g.gain.setValueAtTime(0.001, time); g.gain.exponentialRampToValueAtTime(0.5, time+0.1); g.gain.exponentialRampToValueAtTime(0.001, time+2.5);
  o1.start(time); o2.start(time); o3.start(time);
  o1.stop(time+3.0); o2.stop(time+3.0); o3.stop(time+3.0);
}

// Electric Piano
function playEPiano(time, freq = 440){
  const o1 = ctx.createOscillator(); o1.type='triangle'; o1.frequency.value=freq;
  const o2 = ctx.createOscillator(); o2.type='sine'; o2.frequency.value=freq*2.1;
  const filter = ctx.createBiquadFilter(); filter.type='lowpass'; filter.frequency.value=1200;
  const g = ctx.createGain(); g.gain.value=0.7; g.connect(masterGain);
  o1.connect(filter); o2.connect(filter); filter.connect(g);
  g.gain.setValueAtTime(0.7, time); g.gain.exponentialRampToValueAtTime(0.001, time+1.5);
  o1.start(time); o2.start(time); o1.stop(time+2.0); o2.stop(time+2.0);
}

// Hammond Organ
function playHammond(time, freq = 220){
  const o1 = ctx.createOscillator(); o1.type='sine'; o1.frequency.value=freq;
  const o2 = ctx.createOscillator(); o2.type='sine'; o2.frequency.value=freq*2;
  const o3 = ctx.createOscillator(); o3.type='sine'; o3.frequency.value=freq*3;
  const o4 = ctx.createOscillator(); o4.type='sine'; o4.frequency.value=freq*4;
  const filter = ctx.createBiquadFilter(); filter.type='lowpass'; filter.frequency.value=800; filter.Q.value=5;
  const g = ctx.createGain(); g.gain.value=0.6; g.connect(masterGain);
  o1.connect(filter); o2.connect(filter); o3.connect(filter); o4.connect(filter);
  filter.connect(g);
  g.gain.setValueAtTime(0.001, time); g.gain.exponentialRampToValueAtTime(0.6, time+0.1);
  g.gain.exponentialRampToValueAtTime(0.4, time+1.0); g.gain.exponentialRampToValueAtTime(0.001, time+2.0);
  o1.start(time); o2.start(time); o3.start(time); o4.start(time);
  o1.stop(time+2.5); o2.stop(time+2.5); o3.stop(time+2.5); o4.stop(time+2.5);
}

// Church Organ
function playChurch(time, freq = 165){
  const o1 = ctx.createOscillator(); o1.type='sine'; o1.frequency.value=freq;
  const o2 = ctx.createOscillator(); o2.type='sine'; o2.frequency.value=freq*2;
  const o3 = ctx.createOscillator(); o3.type='sine'; o3.frequency.value=freq*4;
  const o4 = ctx.createOscillator(); o4.type='sine'; o4.frequency.value=freq*5.33;
  const o5 = ctx.createOscillator(); o5.type='sine'; o5.frequency.value=freq*8;
  const g = ctx.createGain(); g.gain.value=0.7; g.connect(masterGain);
  o1.connect(g); o2.connect(g); o3.connect(g); o4.connect(g); o5.connect(g);
  g.gain.setValueAtTime(0.001, time); g.gain.exponentialRampToValueAtTime(0.7, time+0.2);
  g.gain.exponentialRampToValueAtTime(0.5, time+2.0); g.gain.exponentialRampToValueAtTime(0.001, time+4.0);
  o1.start(time); o2.start(time); o3.start(time); o4.start(time); o5.start(time);
  o1.stop(time+4.5); o2.stop(time+4.5); o3.stop(time+4.5); o4.stop(time+4.5); o5.stop(time+4.5);
}

// Accordion
function playAccordion(time, freq = 330){
  const o1 = ctx.createOscillator(); o1.type='sawtooth'; o1.frequency.value=freq;
  const o2 = ctx.createOscillator(); o2.type='square'; o2.frequency.value=freq*1.01; // slight detune
  const vibrato = ctx.createOscillator(); vibrato.type='sine'; vibrato.frequency.value=5;
  const vibratoGain = ctx.createGain(); vibratoGain.gain.value=3;
  const filter = ctx.createBiquadFilter(); filter.type='bandpass'; filter.frequency.value=1000;
  const g = ctx.createGain(); g.gain.value=0.5; g.connect(masterGain);
  vibrato.connect(vibratoGain); vibratoGain.connect(o1.frequency); vibratoGain.connect(o2.frequency);
  o1.connect(filter); o2.connect(filter); filter.connect(g);
  g.gain.setValueAtTime(0.001, time); g.gain.exponentialRampToValueAtTime(0.5, time+0.1);
  g.gain.exponentialRampToValueAtTime(0.001, time+2.0);
  vibrato.start(time); o1.start(time); o2.start(time);
  vibrato.stop(time+2.5); o1.stop(time+2.5); o2.stop(time+2.5);
}

// Harmonica
function playHarmonica(time, freq = 440){
  const o1 = ctx.createOscillator(); o1.type='square'; o1.frequency.value=freq;
  const o2 = ctx.createOscillator(); o2.type='sawtooth'; o2.frequency.value=freq*1.005; // detune
  const filter = ctx.createBiquadFilter(); filter.type='bandpass'; filter.frequency.value=1500; filter.Q.value=8;
  const tremolo = ctx.createOscillator(); tremolo.type='sine'; tremolo.frequency.value=8;
  const tremoloGain = ctx.createGain(); tremoloGain.gain.value=0.3;
  const g = ctx.createGain(); g.gain.value=0.4; g.connect(masterGain);
  tremolo.connect(tremoloGain); tremoloGain.connect(g.gain);
  o1.connect(filter); o2.connect(filter); filter.connect(g);
  g.gain.setValueAtTime(0.4, time); g.gain.exponentialRampToValueAtTime(0.001, time+1.5);
  tremolo.start(time); o1.start(time); o2.start(time);
  tremolo.stop(time+2.0); o1.stop(time+2.0); o2.stop(time+2.0);
}

// Concertina
function playConcertina(time, freq = 330){
  const o1 = ctx.createOscillator(); o1.type='triangle'; o1.frequency.value=freq;
  const o2 = ctx.createOscillator(); o2.type='square'; o2.frequency.value=freq*2;
  const breathNoise = ctx.createBufferSource(); breathNoise.buffer = makeNoiseBuffer();
  const noiseFilter = ctx.createBiquadFilter(); noiseFilter.type='highpass'; noiseFilter.frequency.value=2000;
  const noiseGain = ctx.createGain(); noiseGain.gain.value=0.1;
  const g = ctx.createGain(); g.gain.value=0.4; g.connect(masterGain);
  breathNoise.connect(noiseFilter); noiseFilter.connect(noiseGain); noiseGain.connect(g);
  o1.connect(g); o2.connect(g);
  g.gain.setValueAtTime(0.001, time); g.gain.exponentialRampToValueAtTime(0.4, time+0.05);
  g.gain.exponentialRampToValueAtTime(0.001, time+1.2);
  breathNoise.start(time); o1.start(time); o2.start(time);
  breathNoise.stop(time+1.5); o1.stop(time+1.5); o2.stop(time+1.5);
}

// Grand Piano
function playGrandPiano(time, freq = 440){
  const o1 = ctx.createOscillator(); o1.type='triangle'; o1.frequency.value=freq;
  const o2 = ctx.createOscillator(); o2.type='sine'; o2.frequency.value=freq*2;
  const o3 = ctx.createOscillator(); o3.type='sine'; o3.frequency.value=freq*4;
  const o4 = ctx.createOscillator(); o4.type='sine'; o4.frequency.value=freq*6;
  const g1 = ctx.createGain(); g1.gain.value=0.8;
  const g2 = ctx.createGain(); g2.gain.value=0.4;
  const g3 = ctx.createGain(); g3.gain.value=0.2;
  const g4 = ctx.createGain(); g4.gain.value=0.1;
  const master = ctx.createGain(); master.connect(masterGain);
  o1.connect(g1); o2.connect(g2); o3.connect(g3); o4.connect(g4);
  g1.connect(master); g2.connect(master); g3.connect(master); g4.connect(master);
  master.gain.setValueAtTime(0.6, time); master.gain.exponentialRampToValueAtTime(0.001, time+3.0);
  o1.start(time); o2.start(time); o3.start(time); o4.start(time);
  o1.stop(time+3.5); o2.stop(time+3.5); o3.stop(time+3.5); o4.stop(time+3.5);
}

// Harpsichord
function playHarpsichord(time, freq = 440){
  const o1 = ctx.createOscillator(); o1.type='sawtooth'; o1.frequency.value=freq;
  const o2 = ctx.createOscillator(); o2.type='triangle'; o2.frequency.value=freq*2;
  const filter = ctx.createBiquadFilter(); filter.type='highpass'; filter.frequency.value=800;
  const g = ctx.createGain(); g.gain.value=0.6; g.connect(masterGain);
  o1.connect(filter); o2.connect(filter); filter.connect(g);
  g.gain.setValueAtTime(0.6, time); g.gain.exponentialRampToValueAtTime(0.001, time+0.8);
  o1.start(time); o2.start(time); o1.stop(time+1.2); o2.stop(time+1.2);
}

// Ragtime Piano
function playRagtime(time, freq = 440){
  const o1 = ctx.createOscillator(); o1.type='square'; o1.frequency.value=freq;
  const o2 = ctx.createOscillator(); o2.type='triangle'; o2.frequency.value=freq*1.5;
  const filter = ctx.createBiquadFilter(); filter.type='bandpass'; filter.frequency.value=1000;
  const g = ctx.createGain(); g.gain.value=0.5; g.connect(masterGain);
  o1.connect(filter); o2.connect(filter); filter.connect(g);
  g.gain.setValueAtTime(0.5, time); g.gain.exponentialRampToValueAtTime(0.001, time+1.0);
  o1.start(time); o2.start(time); o1.stop(time+1.5); o2.stop(time+1.5);
}

// Music Box
function playMusicBox(time, freq = 880){
  const o = ctx.createOscillator(); o.type='sine'; o.frequency.value=freq;
  const filter = ctx.createBiquadFilter(); filter.type='highpass'; filter.frequency.value=2000;
  const g = ctx.createGain(); g.gain.value=0.4; g.connect(masterGain);
  o.connect(filter); filter.connect(g);
  g.gain.setValueAtTime(0.4, time); g.gain.exponentialRampToValueAtTime(0.001, time+2.0);
  o.start(time); o.stop(time+2.5);
}

// --- Additional Synthesizers ---
// Arpeggiator
function playArp(time, freq = 440){
  const frequencies = [freq, freq*1.25, freq*1.5, freq*2]; // Major chord arpeggio
  frequencies.forEach((f, i) => {
    const o = ctx.createOscillator(); o.type='square'; o.frequency.value=f;
    const filter = ctx.createBiquadFilter(); filter.type='lowpass'; filter.frequency.value=2000;
    const g = ctx.createGain(); g.gain.value=0.3; g.connect(masterGain);
    o.connect(filter); filter.connect(g);
    const noteTime = time + i * 0.1;
    g.gain.setValueAtTime(0.001, noteTime); g.gain.exponentialRampToValueAtTime(0.3, noteTime+0.01);
    g.gain.exponentialRampToValueAtTime(0.001, noteTime+0.15);
    o.start(noteTime); o.stop(noteTime+0.2);
  });
}

// Sequence Synth
function playSequence(time, freq = 550){
  const notes = [freq, freq*1.125, freq*1.33, freq*1.5]; // Different intervals
  notes.forEach((f, i) => {
    const o = ctx.createOscillator(); o.type='sawtooth'; o.frequency.value=f;
    const filter = ctx.createBiquadFilter(); filter.type='lowpass'; 
    filter.frequency.setValueAtTime(3000, time + i*0.08); filter.frequency.exponentialRampToValueAtTime(800, time + i*0.08 + 0.1);
    const g = ctx.createGain(); g.gain.value=0.25; g.connect(masterGain);
    o.connect(filter); filter.connect(g);
    const noteTime = time + i * 0.08;
    g.gain.setValueAtTime(0.25, noteTime); g.gain.exponentialRampToValueAtTime(0.001, noteTime+0.12);
    o.start(noteTime); o.stop(noteTime+0.15);
  });
}

// Poly Synth
function playPolySynth(time, freq = 330){
  const chord = [freq, freq*1.25, freq*1.5, freq*2]; // Major chord
  chord.forEach(f => {
    const o = ctx.createOscillator(); o.type='sawtooth'; o.frequency.value=f;
    const filter = ctx.createBiquadFilter(); filter.type='lowpass'; filter.frequency.value=1500; filter.Q.value=3;
    const g = ctx.createGain(); g.gain.value=0.15; g.connect(masterGain);
    o.connect(filter); filter.connect(g);
    g.gain.setValueAtTime(0.001, time); g.gain.exponentialRampToValueAtTime(0.15, time+0.1);
    g.gain.exponentialRampToValueAtTime(0.001, time+2.0);
    o.start(time); o.stop(time+2.5);
  });
}

// Mono Synth
function playMonoSynth(time, freq = 220){
  const o = ctx.createOscillator(); o.type='sawtooth'; o.frequency.value=freq;
  const filter = ctx.createBiquadFilter(); filter.type='lowpass'; 
  filter.frequency.setValueAtTime(4000, time); filter.frequency.exponentialRampToValueAtTime(800, time+0.3);
  filter.Q.value=10;
  const g = ctx.createGain(); g.gain.value=0.7; g.connect(masterGain);
  o.connect(filter); filter.connect(g);
  g.gain.setValueAtTime(0.7, time); g.gain.exponentialRampToValueAtTime(0.001, time+1.0);
  o.start(time); o.stop(time+1.2);
}

// FM Synth
function playFMSynth(time, freq = 440){
  const carrier = ctx.createOscillator(); carrier.type='sine'; carrier.frequency.value=freq;
  const modulator = ctx.createOscillator(); modulator.type='sine'; modulator.frequency.value=freq*2;
  const modGain = ctx.createGain(); modGain.gain.value=100;
  const g = ctx.createGain(); g.gain.value=0.5; g.connect(masterGain);
  modulator.connect(modGain); modGain.connect(carrier.frequency);
  carrier.connect(g);
  g.gain.setValueAtTime(0.001, time); g.gain.exponentialRampToValueAtTime(0.5, time+0.05);
  g.gain.exponentialRampToValueAtTime(0.001, time+1.5);
  modulator.start(time); carrier.start(time);
  modulator.stop(time+2.0); carrier.stop(time+2.0);
}

// --- String Instruments ---
// Violin
function playViolin(time, freq = 659){
  const o = ctx.createOscillator(); o.type='sawtooth'; o.frequency.value=freq;
  const vibrato = ctx.createOscillator(); vibrato.type='sine'; vibrato.frequency.value=6;
  const vibratoGain = ctx.createGain(); vibratoGain.gain.value=2;
  const filter = ctx.createBiquadFilter(); filter.type='bandpass'; filter.frequency.value=1500; filter.Q.value=5;
  const g = ctx.createGain(); g.gain.value=0.6; g.connect(masterGain);
  vibrato.connect(vibratoGain); vibratoGain.connect(o.frequency);
  o.connect(filter); filter.connect(g);
  g.gain.setValueAtTime(0.001, time); g.gain.exponentialRampToValueAtTime(0.6, time+0.2);
  g.gain.exponentialRampToValueAtTime(0.4, time+1.5); g.gain.exponentialRampToValueAtTime(0.001, time+2.5);
  vibrato.start(time); o.start(time); vibrato.stop(time+3.0); o.stop(time+3.0);
}

// Viola
function playViola(time, freq = 440){
  const o = ctx.createOscillator(); o.type='sawtooth'; o.frequency.value=freq;
  const vibrato = ctx.createOscillator(); vibrato.type='sine'; vibrato.frequency.value=5;
  const vibratoGain = ctx.createGain(); vibratoGain.gain.value=1.5;
  const filter = ctx.createBiquadFilter(); filter.type='bandpass'; filter.frequency.value=1200; filter.Q.value=4;
  const g = ctx.createGain(); g.gain.value=0.5; g.connect(masterGain);
  vibrato.connect(vibratoGain); vibratoGain.connect(o.frequency);
  o.connect(filter); filter.connect(g);
  g.gain.setValueAtTime(0.001, time); g.gain.exponentialRampToValueAtTime(0.5, time+0.15);
  g.gain.exponentialRampToValueAtTime(0.001, time+2.2);
  vibrato.start(time); o.start(time); vibrato.stop(time+2.5); o.stop(time+2.5);
}

// Cello
function playCello(time, freq = 264){
  const o = ctx.createOscillator(); o.type='sawtooth'; o.frequency.value=freq;
  const vibrato = ctx.createOscillator(); vibrato.type='sine'; vibrato.frequency.value=4;
  const vibratoGain = ctx.createGain(); vibratoGain.gain.value=1;
  const filter = ctx.createBiquadFilter(); filter.type='lowpass'; filter.frequency.value=800; filter.Q.value=3;
  const g = ctx.createGain(); g.gain.value=0.7; g.connect(masterGain);
  vibrato.connect(vibratoGain); vibratoGain.connect(o.frequency);
  o.connect(filter); filter.connect(g);
  g.gain.setValueAtTime(0.001, time); g.gain.exponentialRampToValueAtTime(0.7, time+0.3);
  g.gain.exponentialRampToValueAtTime(0.5, time+2.0); g.gain.exponentialRampToValueAtTime(0.001, time+3.5);
  vibrato.start(time); o.start(time); vibrato.stop(time+4.0); o.stop(time+4.0);
}

// Contrabass
function playContrabass(time, freq = 130){
  const o = ctx.createOscillator(); o.type='sawtooth'; o.frequency.value=freq;
  const filter = ctx.createBiquadFilter(); filter.type='lowpass'; filter.frequency.value=400; filter.Q.value=2;
  const g = ctx.createGain(); g.gain.value=0.8; g.connect(masterGain);
  o.connect(filter); filter.connect(g);
  g.gain.setValueAtTime(0.001, time); g.gain.exponentialRampToValueAtTime(0.8, time+0.4);
  g.gain.exponentialRampToValueAtTime(0.6, time+2.5); g.gain.exponentialRampToValueAtTime(0.001, time+4.0);
  o.start(time); o.stop(time+4.5);
}

// Strings Section
function playStrings(time, freq = 440){
  const notes = [freq, freq*1.25, freq*1.5, freq*2]; // String section chord
  notes.forEach((f, i) => {
    const o = ctx.createOscillator(); o.type='sawtooth'; o.frequency.value=f;
    const vibrato = ctx.createOscillator(); vibrato.type='sine'; vibrato.frequency.value=5 + i*0.2;
    const vibratoGain = ctx.createGain(); vibratoGain.gain.value=1;
    const filter = ctx.createBiquadFilter(); filter.type='lowpass'; filter.frequency.value=1500 - i*200;
    const g = ctx.createGain(); g.gain.value=0.2; g.connect(masterGain);
    vibrato.connect(vibratoGain); vibratoGain.connect(o.frequency);
    o.connect(filter); filter.connect(g);
    g.gain.setValueAtTime(0.001, time); g.gain.exponentialRampToValueAtTime(0.2, time+0.5);
    g.gain.exponentialRampToValueAtTime(0.001, time+3.0);
    vibrato.start(time); o.start(time); vibrato.stop(time+3.5); o.stop(time+3.5);
  });
}

// Pizzicato
function playPizzicato(time, freq = 440){
  const o = ctx.createOscillator(); o.type='triangle'; o.frequency.value=freq;
  const filter = ctx.createBiquadFilter(); filter.type='bandpass'; filter.frequency.value=1500; filter.Q.value=8;
  const g = ctx.createGain(); g.gain.value=0.8; g.connect(masterGain);
  o.connect(filter); filter.connect(g);
  g.gain.setValueAtTime(0.8, time); g.gain.exponentialRampToValueAtTime(0.001, time+0.5);
  o.start(time); o.stop(time+0.8);
}

// --- Effects ---
function playReverse(time){
  // Simulated reverse effect with sweep
  const o = ctx.createOscillator(); o.type='sawtooth'; o.frequency.setValueAtTime(100, time); o.frequency.exponentialRampToValueAtTime(1000, time+1.0);
  const g = ctx.createGain(); g.gain.value=0.5; g.connect(masterGain);
  o.connect(g);
  g.gain.setValueAtTime(0.001, time); g.gain.exponentialRampToValueAtTime(0.5, time+1.0); g.gain.exponentialRampToValueAtTime(0.001, time+1.2);
  o.start(time); o.stop(time+1.5);
}

function playSweep(time){
  const o = ctx.createOscillator(); o.type='sawtooth'; o.frequency.setValueAtTime(2000, time); o.frequency.exponentialRampToValueAtTime(200, time+0.8);
  const filter = ctx.createBiquadFilter(); filter.type='lowpass'; filter.frequency.setValueAtTime(4000, time); filter.frequency.exponentialRampToValueAtTime(500, time+0.8);
  const g = ctx.createGain(); g.gain.value=0.6; g.connect(masterGain);
  o.connect(filter); filter.connect(g);
  g.gain.setValueAtTime(0.6, time); g.gain.exponentialRampToValueAtTime(0.001, time+1.0);
  o.start(time); o.stop(time+1.2);
}

function playWhiteNoise(time){
  const noise = ctx.createBufferSource();
  noise.buffer = makeNoiseBuffer();
  const g = ctx.createGain(); g.gain.value=0.3; g.connect(masterGain);
  noise.connect(g);
  g.gain.setValueAtTime(0.3, time); g.gain.exponentialRampToValueAtTime(0.001, time+0.5);
  noise.start(time); noise.stop(time+0.8);
}

function makeNoiseBuffer(){
  const len = ctx.sampleRate * 1.0;
  const buf = ctx.createBuffer(1,len,ctx.sampleRate);
  const data = buf.getChannelData(0);
  for(let i=0;i<len;i++) data[i] = Math.random()*2-1;
  return buf;
}

// XY Patch Controls State
const xyPatchState = {
  key: 'C',
  scale: 'major',
  velocity: 1.0,
  reverb: 30,
  delay: 0,
  distortion: 0,
  lowpassFreq: 4000,
  resonance: 1.0
};

// Scale definitions
const scales = {
  major: [0, 2, 4, 5, 7, 9, 11],
  minor: [0, 2, 3, 5, 7, 8, 10],
  pentatonic: [0, 2, 4, 7, 9],
  blues: [0, 3, 5, 6, 7, 10],
  chromatic: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11]
};

// Key offsets (semitones from C)
const keyOffsets = {
  'C': 0, 'Db': 1, 'D': 2, 'Eb': 3, 'E': 4, 'F': 5,
  'Gb': 6, 'G': 7, 'Ab': 8, 'A': 9, 'Bb': 10, 'B': 11
};

// Initialize XY Patch Controls
function initXYPatchControls() {
  // Get control elements
  const keySelect = document.getElementById('keySelect');
  const scaleSelect = document.getElementById('scaleSelect');
  const velocityRange = document.getElementById('velocityRange');
  const reverbAmount = document.getElementById('reverbAmount');
  const delayAmount = document.getElementById('delayAmount');
  const distortionAmount = document.getElementById('distortionAmount');
  const lowpassFreq = document.getElementById('lowpassFreq');
  const resonanceAmount = document.getElementById('resonanceAmount');
  
  // Value display elements
  const velocityValue = document.getElementById('velocityValue');
  const reverbValue = document.getElementById('reverbValue');
  const delayValue = document.getElementById('delayValue');
  const distortionValue = document.getElementById('distortionValue');
  const lowpassValue = document.getElementById('lowpassValue');
  const resonanceValue = document.getElementById('resonanceValue');
  const xCoord = document.getElementById('xCoord');
  const yCoord = document.getElementById('yCoord');
  
  // Event listeners for controls
  keySelect.addEventListener('change', () => {
    xyPatchState.key = keySelect.value;
  });
  
  scaleSelect.addEventListener('change', () => {
    xyPatchState.scale = scaleSelect.value;
  });
  
  velocityRange.addEventListener('input', () => {
    xyPatchState.velocity = parseFloat(velocityRange.value);
    velocityValue.textContent = xyPatchState.velocity.toFixed(1);
  });
  
  reverbAmount.addEventListener('input', () => {
    xyPatchState.reverb = parseInt(reverbAmount.value);
    reverbValue.textContent = xyPatchState.reverb + '%';
  });
  
  delayAmount.addEventListener('input', () => {
    xyPatchState.delay = parseInt(delayAmount.value);
    delayValue.textContent = xyPatchState.delay + '%';
  });
  
  distortionAmount.addEventListener('input', () => {
    xyPatchState.distortion = parseInt(distortionAmount.value);
    distortionValue.textContent = xyPatchState.distortion + '%';
  });
  
  lowpassFreq.addEventListener('input', () => {
    xyPatchState.lowpassFreq = parseInt(lowpassFreq.value);
    lowpassValue.textContent = xyPatchState.lowpassFreq + 'Hz';
  });
  
  resonanceAmount.addEventListener('input', () => {
    xyPatchState.resonance = parseFloat(resonanceAmount.value);
    resonanceValue.textContent = xyPatchState.resonance.toFixed(1);
  });
  
  // Patch preset buttons
  document.querySelectorAll('.patch-preset-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const presetName = btn.dataset.preset;
      loadXYPatchPreset(presetName);
      
      // Visual feedback
      document.querySelectorAll('.patch-preset-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    });
  });
}

// Load XY Patch Preset
function loadXYPatchPreset(presetName) {
  const presets = {
    lead: {
      key: 'C', scale: 'minor', velocity: 1.5, reverb: 20, delay: 15,
      distortion: 25, lowpassFreq: 6000, resonance: 8
    },
    bass: {
      key: 'E', scale: 'minor', velocity: 2.0, reverb: 10, delay: 5,
      distortion: 15, lowpassFreq: 800, resonance: 15
    },
    pad: {
      key: 'A', scale: 'major', velocity: 0.8, reverb: 60, delay: 30,
      distortion: 0, lowpassFreq: 2000, resonance: 3
    },
    pluck: {
      key: 'G', scale: 'pentatonic', velocity: 1.2, reverb: 40, delay: 20,
      distortion: 5, lowpassFreq: 5000, resonance: 5
    },
    ambient: {
      key: 'D', scale: 'major', velocity: 0.6, reverb: 80, delay: 50,
      distortion: 0, lowpassFreq: 3000, resonance: 2
    },
    aggressive: {
      key: 'F', scale: 'minor', velocity: 1.8, reverb: 15, delay: 10,
      distortion: 60, lowpassFreq: 4000, resonance: 20
    }
  };
  
  const preset = presets[presetName];
  if (!preset) return;
  
  // Update state and controls
  xyPatchState.key = preset.key;
  xyPatchState.scale = preset.scale;
  xyPatchState.velocity = preset.velocity;
  xyPatchState.reverb = preset.reverb;
  xyPatchState.delay = preset.delay;
  xyPatchState.distortion = preset.distortion;
  xyPatchState.lowpassFreq = preset.lowpassFreq;
  xyPatchState.resonance = preset.resonance;
  
  // Update UI controls
  document.getElementById('keySelect').value = preset.key;
  document.getElementById('scaleSelect').value = preset.scale;
  document.getElementById('velocityRange').value = preset.velocity;
  document.getElementById('reverbAmount').value = preset.reverb;
  document.getElementById('delayAmount').value = preset.delay;
  document.getElementById('distortionAmount').value = preset.distortion;
  document.getElementById('lowpassFreq').value = preset.lowpassFreq;
  document.getElementById('resonanceAmount').value = preset.resonance;
  
  // Update display values
  document.getElementById('velocityValue').textContent = preset.velocity.toFixed(1);
  document.getElementById('reverbValue').textContent = preset.reverb + '%';
  document.getElementById('delayValue').textContent = preset.delay + '%';
  document.getElementById('distortionValue').textContent = preset.distortion + '%';
  document.getElementById('lowpassValue').textContent = preset.lowpassFreq + 'Hz';
  document.getElementById('resonanceValue').textContent = preset.resonance.toFixed(1);
  
  console.log(`üé® Patch preset "${presetName.toUpperCase()}" carregado!`);
}

// Get frequency for scale note
function getScaleFrequency(noteIndex, octave = 4) {
  const keyOffset = keyOffsets[xyPatchState.key];
  const scaleNotes = scales[xyPatchState.scale];
  const noteInScale = scaleNotes[noteIndex % scaleNotes.length];
  const octaveOffset = Math.floor(noteIndex / scaleNotes.length);
  const semitone = keyOffset + noteInScale + (octave + octaveOffset) * 12;
  return 440 * Math.pow(2, (semitone - 69) / 12); // A4 = 440Hz = MIDI note 69
}

// Create effects chain
function createEffectsChain(source) {
  let current = source;
  
  // Distortion
  if (xyPatchState.distortion > 0) {
    const waveshaper = ctx.createWaveShaper();
    const amount = xyPatchState.distortion / 100;
    const samples = 44100;
    const curve = new Float32Array(samples);
    const deg = Math.PI / 180;
    
    for (let i = 0; i < samples; i++) {
      const x = (i * 2) / samples - 1;
      curve[i] = ((3 + amount) * x * 20 * deg) / (Math.PI + amount * Math.abs(x));
    }
    
    waveshaper.curve = curve;
    current.connect(waveshaper);
    current = waveshaper;
  }
  
  // Low-pass filter
  const filter = ctx.createBiquadFilter();
  filter.type = 'lowpass';
  filter.frequency.value = xyPatchState.lowpassFreq;
  filter.Q.value = xyPatchState.resonance;
  current.connect(filter);
  current = filter;
  
  // Delay
  if (xyPatchState.delay > 0) {
    const delayNode = ctx.createDelay(1.0);
    const feedback = ctx.createGain();
    const delayGain = ctx.createGain();
    
    delayNode.delayTime.value = (xyPatchState.delay / 100) * 0.3;
    feedback.gain.value = 0.4;
    delayGain.gain.value = xyPatchState.delay / 200;
    
    current.connect(delayNode);
    delayNode.connect(feedback);
    feedback.connect(delayNode);
    delayNode.connect(delayGain);
    delayGain.connect(masterGain);
  }
  
  // Reverb (simplified)
  if (xyPatchState.reverb > 0) {
    const convolver = ctx.createConvolver();
    const reverbGain = ctx.createGain();
    reverbGain.gain.value = xyPatchState.reverb / 200;
    
    // Create simple impulse response
    const length = ctx.sampleRate * 2;
    const impulse = ctx.createBuffer(2, length, ctx.sampleRate);
    for (let channel = 0; channel < 2; channel++) {
      const channelData = impulse.getChannelData(channel);
      for (let i = 0; i < length; i++) {
        channelData[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, 2);
      }
    }
    
    convolver.buffer = impulse;
    current.connect(convolver);
    convolver.connect(reverbGain);
    reverbGain.connect(masterGain);
  }
  
  return current;
}

// Hook pads UI
document.querySelectorAll('.pad').forEach(el=>{
  el.addEventListener('pointerdown',async (e)=>{ 
    await ensureResume(); 
    const p = el.dataset.pad; 
    const t = now();
    
    // Drum sounds
    if(p==='kick') playKick(t);
    else if(p==='snare') playSnare(t);
    else if(p==='hat') playHat(t);
    else if(p==='openhat') playOpenHat(t);
    else if(p==='crash') playCrash(t);
    else if(p==='ride') playRide(t);
    else if(p==='tom') playTom(t);
    else if(p==='clap') playClap(t);
    else if(p==='perc') playPerc(t);
    
    // Piano & Keyboard instruments
    else if(p==='piano') playPiano(t, 440);
    else if(p==='epiano') playEPiano(t, 440);
    else if(p==='grandpiano') playGrandPiano(t, 440);
    else if(p==='harpsichord') playHarpsichord(t, 440);
    else if(p==='ragtime') playRagtime(t, 440);
    else if(p==='musicbox') playMusicBox(t, 880);
    
    // Organs & Keys
    else if(p==='organ') playOrgan(t, 330);
    else if(p==='hammond') playHammond(t, 220);
    else if(p==='church') playChurch(t, 165);
    else if(p==='accordion') playAccordion(t, 330);
    else if(p==='harmonica') playHarmonica(t, 440);
    else if(p==='concertina') playConcertina(t, 330);
    
    // Synthesizers
    else if(p==='bass') playBass(t, 110);
    else if(p==='lead') playLead(t, 880);
    else if(p==='synthpad') playSynthPad(t, 220);
    else if(p==='pluck') playPluck(t, 660);
    else if(p==='arp') playArp(t, 440);
    else if(p==='sequence') playSequence(t, 550);
    else if(p==='polysynth') playPolySynth(t, 330);
    else if(p==='monosynth') playMonoSynth(t, 220);
    else if(p==='fm') playFMSynth(t, 440);
    
    // String instruments
    else if(p==='violin') playViolin(t, 659);
    else if(p==='viola') playViola(t, 440);
    else if(p==='cello') playCello(t, 264);
    else if(p==='contrabass') playContrabass(t, 130);
    else if(p==='strings') playStrings(t, 440);
    else if(p==='pizzicato') playPizzicato(t, 440);
    
    // Effects
    else if(p==='reverse') playReverse(t);
    else if(p==='sweep') playSweep(t);
    else if(p==='whitenoise') playWhiteNoise(t);
    
    // Visual feedback
    el.style.transform = 'scale(0.95)';
    setTimeout(() => { el.style.transform = ''; }, 100);
    
    // Add to sequencer if recording
    if(sequencer.recording) {
      addToSequencer(p);
    }
  });
});

// --- Transport / metronome ---
let metroInterval = null;
function startTransport(){ state.playing=true; startStopBtn.textContent='Stop'; if(state.metro) startMetro(); }
function stopTransport(){ state.playing=false; startStopBtn.textContent='Start'; stopMetro(); }
function startMetro(){ stopMetro(); const beatInterval = 60/state.bpm; metroInterval = setInterval(()=>{ const t=now()+0.02; playClick(t); }, beatInterval*1000); }
function stopMetro(){ if(metroInterval) clearInterval(metroInterval); metroInterval=null; }
function playClick(time){ const o = ctx.createOscillator(); const g = ctx.createGain(); g.connect(masterGain); o.connect(g); o.frequency.value=1200; g.gain.setValueAtTime(0.0001,time); g.gain.exponentialRampToValueAtTime(0.8,time+0.001); g.gain.exponentialRampToValueAtTime(0.0001,time+0.08); o.start(time); o.stop(time+0.1); }

// Ensure audio resume on interaction (mobile policies)
async function ensureResume(){ if(ctx.state==='suspended'){ await ctx.resume(); } }
window.addEventListener('pointerdown', ()=>{ ensureResume(); });

// --- XY Pad Implementation ---
const canvas = xyCanvas; const rect = ()=>canvas.getBoundingClientRect();
canvas.width = Math.floor(rect().width * devicePixelRatio);
canvas.height = Math.floor(rect().height * devicePixelRatio);
const g = canvas.getContext('2d'); g.scale(devicePixelRatio, devicePixelRatio);
let pointer = null; const centerA={x:80,y:80}; const centerB={x:canvas.width/devicePixelRatio-80,y:canvas.height/devicePixelRatio-80};
function drawGuide(){ g.clearRect(0,0,canvas.width/devicePixelRatio,canvas.height/devicePixelRatio);
  // gradient background
  const W = canvas.width/devicePixelRatio, H = canvas.height/devicePixelRatio;
  const grd = g.createLinearGradient(0,0,W,H); grd.addColorStop(0,'rgba(31,182,255,0.06)'); grd.addColorStop(1,'rgba(255,255,255,0.02)');
  g.fillStyle = grd; g.fillRect(0,0,W,H);
  // draw points A and B
  g.fillStyle='rgba(255,255,255,0.06)'; g.beginPath(); g.arc(centerA.x,centerA.y,12,0,Math.PI*2); g.fill();
  g.beginPath(); g.arc(centerB.x,centerB.y,12,0,Math.PI*2); g.fill();
  // line between
  g.strokeStyle='rgba(255,255,255,0.04)'; g.lineWidth=2; g.beginPath(); g.moveTo(centerA.x,centerA.y); g.lineTo(centerB.x,centerB.y); g.stroke();
  // pointer
  if(pointer){ g.fillStyle='rgba(31,182,255,0.9)'; g.beginPath(); g.arc(pointer.x,pointer.y,10,0,Math.PI*2); g.fill(); }
}

drawGuide();

function interp(a,b,t){return a+(b-a)*t}

async function handlePointer(x,y){ await ensureResume(); pointer = {x,y}; drawGuide();
  // Update coordinate display
  updateXYCoordinates(x, y);
  
  // compute t along line A->B projection
  const ax=centerA.x, ay=centerA.y, bx=centerB.x, by=centerB.y;
  const vx = bx-ax, vy = by-ay; const wx = x-ax, wy = y-ay;
  const vlen2 = vx*vx+vy*vy; let t = 0; if(vlen2>0) t = Math.max(0, Math.min(1, (vx*wx + vy*wy)/vlen2));
  // vertical influence (distance from line) -> map to pitch or volume
  const projx = interp(ax,bx,t), projy = interp(ay,by,t);
  const dist = Math.hypot(x-projx, y-projy);
  const maxDist = Math.min(canvas.width/devicePixelRatio, canvas.height/devicePixelRatio)/2;
  const yInfluence = 1 - Math.min(1, dist/maxDist);

  // Use new patch-aware XY synthesis instead of old methods
  playXYWithPatch(t, yInfluence);
}

// --- XY mode implementations ---
function playXYOsc(t,yInf){
  const baseFreq = 220; // A3
  const freq = baseFreq * Math.pow(2, (t-0.5)*state.pitchRange);
  const o = ctx.createOscillator(); o.type='sawtooth'; o.frequency.value=freq;
  const g = ctx.createGain(); g.gain.value = yInf*0.6; g.connect(masterGain);
  // simple filter varying with t
  const f = ctx.createBiquadFilter(); f.type='lowpass'; f.frequency.value = interp(500,5000,t);
  o.connect(f); f.connect(g);
  o.start(); o.stop(now()+0.6);
}

function playBlendSample(t,yInf){
  // we synthesize two simple timbres and blend between them
  // timbreA = sine, timbreB = square
  const baseFreq = 440 * Math.pow(2,(t-0.5)*state.pitchRange);
  const a = ctx.createOscillator(); a.type='sine'; a.frequency.value=baseFreq;
  const b = ctx.createOscillator(); b.type='square'; b.frequency.value=baseFreq;
  const gA = ctx.createGain(); const gB = ctx.createGain(); gA.connect(masterGain); gB.connect(masterGain);
  gA.gain.value = 1-t; gB.gain.value = t;
  const env = ctx.createGain(); env.connect(masterGain);
  a.connect(gA); b.connect(gB);
  gA.connect(env); gB.connect(env);
  env.gain.setValueAtTime(yInf,now()); env.gain.exponentialRampToValueAtTime(0.001, now()+0.7);
  a.start(); b.start(); a.stop(now()+0.7); b.stop(now()+0.7);
}

function playMorphDrum(t,yInf){
  // choose mix between kick and snare
  const time = now();
  if(t<0.4){ playKick(time); }
  else if(t<0.7){ playTom(time); }
  else { playSnare(time); }
}

// Pointer events
let isDown=false;
function getXYFromEvent(e){ const r=rect(); const x = (e.clientX||e.touches[0].clientX) - r.left; const y = (e.clientY||e.touches[0].clientY) - r.top; return {x,y}; }
canvas.addEventListener('pointerdown',(ev)=>{ isDown=true; const p=getXYFromEvent(ev); handlePointer(p.x,p.y); });
canvas.addEventListener('pointermove',(ev)=>{ if(!isDown) return; const p=getXYFromEvent(ev); handlePointer(p.x,p.y); });
canvas.addEventListener('pointerup',(ev)=>{ isDown=false; pointer=null; drawGuide(); });
canvas.addEventListener('pointercancel',(ev)=>{ isDown=false; pointer=null; drawGuide(); });

// Update XY coordinate display
function updateXYCoordinates(x, y) {
  const xCoordEl = document.getElementById('xCoord');
  const yCoordEl = document.getElementById('yCoord');
  
  if (xCoordEl && yCoordEl) {
    const normalizedX = x / (canvas.width / devicePixelRatio);
    const normalizedY = y / (canvas.height / devicePixelRatio);
    
    xCoordEl.textContent = normalizedX.toFixed(2);
    yCoordEl.textContent = normalizedY.toFixed(2);
  }
}

// Enhanced XY control with scale and effects integration
function playXYWithPatch(t, yInf) {
  const time = now();
  
  // Use current patch settings to generate notes
  const scaleNotes = scales[xyPatchState.scale];
  const noteIndex = Math.floor(t * scaleNotes.length);
  const frequency = getScaleFrequency(noteIndex, 4);
  
  // Create oscillator with patch settings
  const o = ctx.createOscillator();
  o.type = 'sawtooth';
  o.frequency.value = frequency;
  
  // Apply velocity scaling
  const gain = ctx.createGain();
  gain.gain.value = yInf * xyPatchState.velocity * 0.4;
  
  // Connect through effects chain
  const effectsOutput = createEffectsChain(o);
  effectsOutput.connect(gain);
  gain.connect(masterGain);
  
  // Envelope
  gain.gain.setValueAtTime(0.001, time);
  gain.gain.exponentialRampToValueAtTime(yInf * xyPatchState.velocity * 0.4, time + 0.01);
  gain.gain.exponentialRampToValueAtTime(0.001, time + 0.8);
  
  o.start(time);
  o.stop(time + 1.0);
  
  console.log(`üéº Note played: ${frequency.toFixed(1)}Hz in ${xyPatchState.key} ${xyPatchState.scale}`);
}

// Resize handling
window.addEventListener('resize',()=>{ canvas.width = Math.floor(rect().width * devicePixelRatio); canvas.height = Math.floor(rect().height * devicePixelRatio); g.scale(devicePixelRatio,devicePixelRatio); centerB.x = canvas.width/devicePixelRatio-80; centerB.y = canvas.height/devicePixelRatio-80; drawGuide(); });

// Presets (localStorage)
function savePreset(){ const p = {bpm:state.bpm, pitchRange:state.pitchRange, masterVol:state.masterVol, mode:state.mode}; const arr = JSON.parse(localStorage.getItem('sint_presets')||'[]'); arr.push(p); localStorage.setItem('sint_presets', JSON.stringify(arr)); renderPresets(); }
function renderPresets(){ const list = document.getElementById('presets'); list.innerHTML=''; const arr = JSON.parse(localStorage.getItem('sint_presets')||'[]'); arr.forEach((pr,i)=>{ const el=document.createElement('div'); el.className='preset'; el.textContent=`Preset ${i+1} (BPM ${pr.bpm})`; el.addEventListener('click',()=>{ state.bpm=pr.bpm; bpmSlider.value=pr.bpm; state.pitchRange=pr.pitchRange; pitchRange.value=pr.pitchRange; state.masterVol=pr.masterVol; masterVol.value=pr.masterVol; state.mode=pr.mode; modeSel.value=pr.mode; }); list.appendChild(el); }); }

document.getElementById('savePreset').addEventListener('click',savePreset);
renderPresets();

// Utility: resume audio on first gesture
window.addEventListener('pointerdown',()=>{ if(ctx.state==='suspended') ctx.resume(); });

// --- Sequencer Implementation ---
function initSequencer() {
  const table = document.getElementById('sequencerTable');
  table.innerHTML = '';
  
  // Create header
  const thead = document.createElement('thead');
  const headerRow = document.createElement('tr');
  
  // Track name header
  const trackHeader = document.createElement('th');
  trackHeader.textContent = 'TRACKS';
  headerRow.appendChild(trackHeader);
  
  // Step number headers (1-16)
  for(let step = 0; step < sequencer.steps; step++) {
    const stepHeader = document.createElement('th');
    stepHeader.textContent = String(step + 1).padStart(2, '0');
    headerRow.appendChild(stepHeader);
  }
  
  thead.appendChild(headerRow);
  table.appendChild(thead);
  
  // Create body
  const tbody = document.createElement('tbody');
  
  // Create track rows
  sequencer.tracks.forEach((track, trackIndex) => {
    const row = document.createElement('tr');
    row.className = 'track-row';
    
    // Track name cell
    const nameCell = document.createElement('td');
    nameCell.className = 'track-name-cell';
    nameCell.textContent = track.name;
    row.appendChild(nameCell);
    
    // Step cells
    for(let step = 0; step < sequencer.steps; step++) {
      const stepCell = document.createElement('td');
      stepCell.className = 'step-cell';
      stepCell.dataset.track = trackIndex;
      stepCell.dataset.step = step;
      
      if(track.pattern[step]) {
        stepCell.classList.add('active');
      }
      
      stepCell.addEventListener('click', () => {
        track.pattern[step] = !track.pattern[step];
        stepCell.classList.toggle('active', track.pattern[step]);
      });
      
      row.appendChild(stepCell);
    }
    
    tbody.appendChild(row);
  });
  
  table.appendChild(tbody);
}

function startSequencer() {
  if(sequencer.playing) return;
  
  sequencer.playing = true;
  sequencer.currentStep = 0;
  seqPlayBtn.textContent = '‚è∏ PAUSE';
  
  const stepTime = 60 / sequencer.bpm / 4; // 16th notes
  
  sequencer.interval = setInterval(() => {
    playSequencerStep();
    updatePlayhead();
    sequencer.currentStep = (sequencer.currentStep + 1) % sequencer.steps;
  }, stepTime * 1000);
  
  // Start recording if needed
  if(sequencer.recording && !sequencer.mediaRecorder) {
    startAudioRecording();
  }
}

function stopSequencer() {
  sequencer.playing = false;
  sequencer.currentStep = 0;
  seqPlayBtn.textContent = '‚ñ∂ PLAY';
  
  if(sequencer.interval) {
    clearInterval(sequencer.interval);
    sequencer.interval = null;
  }
  
  updatePlayhead();
  
  // Stop recording if active
  if(sequencer.mediaRecorder && sequencer.mediaRecorder.state === 'recording') {
    sequencer.mediaRecorder.stop();
  }
}

function playSequencerStep() {
  const time = now();
  
  sequencer.tracks.forEach(track => {
    if(track.pattern[sequencer.currentStep]) {
      playSound(track.sound, time);
    }
  });
}

function playSound(soundName, time) {
  // Map sounds to functions
  const soundMap = {
    kick: () => playKick(time),
    snare: () => playSnare(time),
    hat: () => playHat(time),
    openhat: () => playOpenHat(time),
    crash: () => playCrash(time),
    ride: () => playRide(time),
    tom: () => playTom(time),
    clap: () => playClap(time),
    perc: () => playPerc(time),
    piano: () => playPiano(time, 440),
    bass: () => playBass(time, 110),
    lead: () => playLead(time, 880),
    synthpad: () => playSynthPad(time, 220),
    pluck: () => playPluck(time, 660),
    organ: () => playOrgan(time, 330),
    reverse: () => playReverse(time),
    sweep: () => playSweep(time),
    whitenoise: () => playWhiteNoise(time)
  };
  
  if(soundMap[soundName]) {
    soundMap[soundName]();
  }
}

function updatePlayhead() {
  const playhead = document.getElementById('playhead');
  const table = document.getElementById('sequencerTable');
  
  if(!table) return;
  
  const tableRect = table.getBoundingClientRect();
  const firstRow = table.querySelector('tr');
  const trackNameCell = firstRow?.querySelector('th');
  const trackNameWidth = trackNameCell?.getBoundingClientRect().width || 100;
  
  const availableWidth = tableRect.width - trackNameWidth;
  const stepWidth = availableWidth / sequencer.steps;
  const playheadX = trackNameWidth + (sequencer.currentStep * stepWidth) + (stepWidth / 2);
  
  playhead.style.left = playheadX + 'px';
  
  // Update current step highlighting
  document.querySelectorAll('.step-cell.current').forEach(cell => {
    cell.classList.remove('current');
  });
  
  if(sequencer.playing) {
    document.querySelectorAll(`[data-step="${sequencer.currentStep}"]`).forEach(cell => {
      if(cell.classList.contains('step-cell')) {
        cell.classList.add('current');
      }
    });
  }
}

function addToSequencer(soundName) {
  // Find the track for this sound
  const track = sequencer.tracks.find(t => t.sound === soundName);
  if(track) {
    track.pattern[sequencer.currentStep] = true;
    initSequencer(); // Refresh UI
  }
}

function clearSequencer() {
  sequencer.tracks.forEach(track => {
    track.pattern.fill(false);
  });
  initSequencer();
}

function toggleRecording() {
  sequencer.recording = !sequencer.recording;
  seqRecordBtn.classList.toggle('recording', sequencer.recording);
  seqRecordBtn.textContent = sequencer.recording ? '‚èπ PARAR GRAV' : '‚è∫ GRAVAR';
  
  if(!sequencer.recording && sequencer.mediaRecorder && sequencer.mediaRecorder.state === 'recording') {
    sequencer.mediaRecorder.stop();
  }
}

// Audio recording functions
async function startAudioRecording() {
  try {
    // Create audio destination for recording
    const dest = ctx.createMediaStreamDestination();
    masterGain.connect(dest);
    
    sequencer.recordedChunks = [];
    sequencer.mediaRecorder = new MediaRecorder(dest.stream);
    
    sequencer.mediaRecorder.ondataavailable = (event) => {
      if(event.data.size > 0) {
        sequencer.recordedChunks.push(event.data);
      }
    };
    
    sequencer.mediaRecorder.onstop = () => {
      const blob = new Blob(sequencer.recordedChunks, { type: 'audio/webm' });
      downloadRecording(blob);
    };
    
    sequencer.mediaRecorder.start();
    console.log('üéôÔ∏è Grava√ß√£o iniciada!');
  } catch (error) {
    console.error('Erro ao iniciar grava√ß√£o:', error);
  }
}

function downloadRecording(blob) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `synthbat-recording-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.webm`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  console.log('üéµ Grava√ß√£o salva!');
}

function saveSequence() {
  const sequence = {
    bpm: sequencer.bpm,
    tracks: sequencer.tracks.map(track => ({
      name: track.name,
      sound: track.sound,
      pattern: [...track.pattern]
    }))
  };
  
  const blob = new Blob([JSON.stringify(sequence, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `synthbat-sequence-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  console.log('üíæ Sequ√™ncia salva!');
}

function loadSequence() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = (event) => {
    const file = event.target.files[0];
    if(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const sequence = JSON.parse(e.target.result);
          
          // Load BPM
          sequencer.bpm = sequence.bpm || 120;
          seqBpmSlider.value = sequencer.bpm;
          seqBpmDisplay.textContent = sequencer.bpm;
          
          // Load patterns
          sequence.tracks.forEach((loadedTrack, index) => {
            if(sequencer.tracks[index]) {
              sequencer.tracks[index].pattern = [...loadedTrack.pattern];
            }
          });
          
          initSequencer();
          console.log('üìÅ Sequ√™ncia carregada!');
        } catch (error) {
          console.error('Erro ao carregar sequ√™ncia:', error);
          alert('Erro ao carregar arquivo. Verifique se √© um arquivo de sequ√™ncia v√°lido.');
        }
      };
      reader.readAsText(file);
    }
  };
  
  input.click();
}

// Initialize sequencer on load
initSequencer();

// --- Drag and Drop Functionality ---
let draggedCard = null;
let dragOffset = { x: 0, y: 0 };

// Make cards draggable
document.querySelectorAll('.card').forEach(card => {
  card.addEventListener('dragstart', (e) => {
    // Check if card is pinned
    if (card.classList.contains('pinned')) {
      e.preventDefault();
      showPinNotification('Card est√° fixado - Clique no üìå para desfixar', '#ff4757');
      return;
    }
    
    draggedCard = card;
    card.classList.add('dragging');
    
    // Show drop hint
    document.getElementById('dropHint').classList.add('show');
    
    // Set drag data
    e.dataTransfer.setData('text/plain', card.id);
    e.dataTransfer.effectAllowed = 'move';
  });
  
  card.addEventListener('dragend', (e) => {
    card.classList.remove('dragging');
    document.getElementById('dropHint').classList.remove('show');
    draggedCard = null;
  });
});

// Handle drop zones
document.getElementById('appContainer').addEventListener('dragover', (e) => {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
});

document.getElementById('appContainer').addEventListener('drop', (e) => {
  e.preventDefault();
  
  if (!draggedCard) return;
  
  // Find the closest card container or app container
  const dropTarget = e.target.closest('.card-container') || document.getElementById('appContainer');
  
  if (dropTarget && dropTarget !== draggedCard.parentElement) {
    // Move the card
    if (dropTarget.id === 'appContainer') {
      // Drop directly in app container
      dropTarget.appendChild(draggedCard.parentElement);
    } else {
      // Insert before the target container
      dropTarget.parentElement.insertBefore(draggedCard.parentElement, dropTarget);
    }
    
    // Show success indicator
    showLayoutIndicator();
    
    // Save layout
    saveLayout();
  }
});

// --- Card Pin/Unpin Functionality ---
document.querySelectorAll('.pin-btn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    e.stopPropagation();
    const cardId = btn.dataset.card;
    const card = document.getElementById(cardId);
    
    if (card.classList.contains('pinned')) {
      // Unpin card
      card.classList.remove('pinned');
      card.draggable = true;
      btn.classList.remove('pinned');
      btn.title = 'Fixar Card';
      
      // Show notification
      showPinNotification('Card desfixado - Agora pode ser movido', '#ff4757');
    } else {
      // Pin card
      card.classList.add('pinned');
      card.draggable = false;
      btn.classList.add('pinned');
      btn.title = 'Desfixar Card';
      
      // Show notification
      showPinNotification('Card fixado - N√£o se mover√° durante uso', '#2ed573');
    }
    
    // Save pin state
    savePinState();
  });
});

function showPinNotification(message, color) {
  const notification = document.createElement('div');
  notification.className = 'pin-notification';
  notification.innerHTML = `
    <div class="pin-notification-content">
      ${message}
    </div>
  `;
  
  // Style the notification
  Object.assign(notification.style, {
    position: 'fixed',
    top: '20px',
    right: '20px',
    background: color,
    color: '#fff',
    padding: '12px 16px',
    borderRadius: '8px',
    fontWeight: '600',
    fontSize: '13px',
    zIndex: '10006',
    boxShadow: `0 4px 15px ${color}40`,
    animation: 'slideInRight 0.3s ease, slideOutRight 0.3s ease 2.5s',
    backdropFilter: 'blur(10px)'
  });
  
  // Add to page
  document.body.appendChild(notification);
  
  // Remove after animation
  setTimeout(() => {
    if (document.body.contains(notification)) {
      document.body.removeChild(notification);
    }
  }, 3000);
}

function savePinState() {
  const pinned = [];
  document.querySelectorAll('.card.pinned').forEach(card => {
    pinned.push(card.id);
  });
  localStorage.setItem('synthbat_pinned_cards', JSON.stringify(pinned));
}

function loadPinState() {
  const saved = localStorage.getItem('synthbat_pinned_cards');
  if (!saved) return;
  
  try {
    const pinned = JSON.parse(saved);
    pinned.forEach(cardId => {
      const card = document.getElementById(cardId);
      const btn = document.querySelector(`[data-card="${cardId}"].pin-btn`);
      if (card && btn) {
        card.classList.add('pinned');
        card.draggable = false;
        btn.classList.add('pinned');
        btn.title = 'Desfixar Card';
      }
    });
    console.log('üìå Estado de fixa√ß√£o dos cards restaurado');
  } catch (error) {
    console.error('Erro ao carregar estado de fixa√ß√£o:', error);
  }
}

// --- Card Collapse/Expand Functionality ---
document.querySelectorAll('.collapse-btn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    e.stopPropagation();
    const cardId = btn.dataset.card;
    const card = document.getElementById(cardId);
    const cardContent = card.querySelector('.card-content');
    const cardContainer = card.closest('.card-container');
    
    // Store original position for smooth centering
    const originalRect = card.getBoundingClientRect();
    const containerRect = cardContainer.getBoundingClientRect();
    
    if (card.classList.contains('collapsed')) {
      // Expand with centered animation
      const currentCenter = originalRect.left + originalRect.width / 2;
      
      // Calculate expansion offset to keep centered
      card.style.transformOrigin = 'center center';
      
      // Smooth expand animation
      requestAnimationFrame(() => {
        card.classList.remove('collapsed');
        btn.textContent = '‚àí';
        btn.classList.remove('collapsed');
        btn.title = 'Recolher';
        
        // After expansion, adjust position if needed to prevent overlap
        setTimeout(() => {
          adjustCardPositionToPreventOverlap(card, cardContainer);
        }, 100);
      });
    } else {
      // Collapse with centered animation
      card.style.transformOrigin = 'center center';
      
      // Smooth collapse animation
      card.classList.add('collapsed');
      btn.textContent = '+';
      btn.classList.add('collapsed');
      btn.title = 'Expandir';
    }
    
    // Save layout state
    saveLayout();
  });
});

// Function to adjust card position to prevent overlap
function adjustCardPositionToPreventOverlap(card, container) {
  const app = document.getElementById('appContainer');
  const isMultiColumn = app.classList.contains('multi-column');
  
  if (!isMultiColumn) return; // No adjustment needed in single column
  
  const cardRect = card.getBoundingClientRect();
  const appRect = app.getBoundingClientRect();
  
  // Check for overlaps with other cards
  const allCards = document.querySelectorAll('.card:not(.collapsed)');
  let hasOverlap = false;
  
  allCards.forEach(otherCard => {
    if (otherCard === card) return;
    
    const otherRect = otherCard.getBoundingClientRect();
    
    // Check if cards overlap
    if (!(cardRect.right < otherRect.left || 
          cardRect.left > otherRect.right || 
          cardRect.bottom < otherRect.top || 
          cardRect.top > otherRect.bottom)) {
      hasOverlap = true;
    }
  });
  
  // If overlap detected, adjust position
  if (hasOverlap) {
    const viewportWidth = window.innerWidth;
    const cardWidth = cardRect.width;
    
    // Try to center the card in available space
    const availableSpace = viewportWidth - cardWidth - 40; // 40px margin
    const optimalLeft = Math.max(20, availableSpace / 2);
    
    // Apply smooth repositioning
    container.style.transition = 'transform 0.3s ease';
    container.style.transform = `translateX(${optimalLeft - cardRect.left + appRect.left}px)`;
    
    // Reset transform after animation
    setTimeout(() => {
      container.style.transform = '';
      container.style.transition = '';
    }, 300);
  }
}

// --- Layout Management ---
function saveLayout() {
  const layout = {
    cards: [],
    collapsed: []
  };
  
  // Save card order
  document.querySelectorAll('.card-container').forEach((container, index) => {
    const card = container.querySelector('.card');
    if (card) {
      layout.cards.push({
        id: card.id,
        index: index,
        container: container.className
      });
      
      // Save collapsed state
      if (card.classList.contains('collapsed')) {
        layout.collapsed.push(card.id);
      }
    }
  });
  
  localStorage.setItem('synthbat_layout', JSON.stringify(layout));
}

function loadLayout() {
  const saved = localStorage.getItem('synthbat_layout');
  if (!saved) return;
  
  try {
    const layout = JSON.parse(saved);
    
    // Restore collapsed states
    layout.collapsed.forEach(cardId => {
      const card = document.getElementById(cardId);
      const btn = document.querySelector(`[data-card="${cardId}"]`);
      if (card && btn) {
        card.classList.add('collapsed');
        btn.textContent = '+';
        btn.classList.add('collapsed');
        btn.title = 'Expandir';
      }
    });
    
    // Note: Card reordering would require more complex DOM manipulation
    // For now, we just restore collapse states
    console.log('üîß Layout carregado do localStorage');
  } catch (error) {
    console.error('Erro ao carregar layout:', error);
  }
}

function showLayoutIndicator() {
  const indicator = document.getElementById('layoutIndicator');
  indicator.classList.add('show');
  setTimeout(() => {
    indicator.classList.remove('show');
  }, 2000);
}

// --- Touch Support for Mobile ---
let touchStartX = 0;
let touchStartY = 0;
let currentTouchCard = null;

document.addEventListener('touchstart', (e) => {
  const card = e.target.closest('.card');
  if (card && e.target.closest('.card-header')) {
    // Check if card is pinned
    if (card.classList.contains('pinned')) {
      return;
    }
    
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
    currentTouchCard = card;
  }
});

document.addEventListener('touchmove', (e) => {
  if (currentTouchCard) {
    e.preventDefault();
    const touch = e.touches[0];
    const deltaX = touch.clientX - touchStartX;
    const deltaY = touch.clientY - touchStartY;
    
    // Visual feedback for touch drag
    if (Math.abs(deltaX) > 10 || Math.abs(deltaY) > 10) {
      currentTouchCard.style.transform = `translate(${deltaX * 0.3}px, ${deltaY * 0.3}px) rotate(${deltaX * 0.1}deg)`;
      currentTouchCard.style.opacity = '0.8';
    }
  }
});

document.addEventListener('touchend', (e) => {
  if (currentTouchCard) {
    currentTouchCard.style.transform = '';
    currentTouchCard.style.opacity = '';
    currentTouchCard = null;
  }
});

// Load saved layout and pin state on startup
loadLayout();
loadPinState();

// --- Splash Screen Implementation ---
class SplashScreen {
  constructor() {
    this.splashElement = document.getElementById('splashScreen');
    this.progressElement = document.getElementById('loadingProgress');
    this.percentageElement = document.getElementById('loadingPercentage');
    this.particlesContainer = document.getElementById('splashParticles');
    this.progress = 0;
    this.isComplete = false;
    
    this.init();
  }
  
  init() {
    this.createParticles();
    this.startLoading();
  }
  
  createParticles() {
    const particleCount = 50;
    
    for (let i = 0; i < particleCount; i++) {
      const particle = document.createElement('div');
      particle.className = 'particle';
      
      // Random positioning and delay
      particle.style.left = Math.random() * 100 + '%';
      particle.style.animationDelay = Math.random() * 10 + 's';
      particle.style.animationDuration = (8 + Math.random() * 4) + 's';
      
      // Random sizes
      const size = 2 + Math.random() * 3;
      particle.style.width = size + 'px';
      particle.style.height = size + 'px';
      
      // Random opacity
      particle.style.opacity = 0.3 + Math.random() * 0.5;
      
      this.particlesContainer.appendChild(particle);
    }
  }
  
  startLoading() {
    const loadingSteps = [
      { text: 'Inicializando Web Audio...', duration: 800 },
      { text: 'Carregando sintetizadores...', duration: 600 },
      { text: 'Preparando sequenciador...', duration: 700 },
      { text: 'Configurando interface...', duration: 500 },
      { text: 'Carregando patches de ritmo...', duration: 400 },
      { text: 'Finalizando...', duration: 300 }
    ];
    
    let currentStep = 0;
    const totalDuration = loadingSteps.reduce((sum, step) => sum + step.duration, 0);
    let elapsed = 0;
    
    const progressInterval = setInterval(() => {
      elapsed += 50;
      this.progress = Math.min((elapsed / totalDuration) * 100, 100);
      this.updateProgress();
      
      if (this.progress >= 100) {
        clearInterval(progressInterval);
        setTimeout(() => this.complete(), 500);
      }
    }, 50);
    
    // Update loading text
    const textInterval = setInterval(() => {
      if (currentStep < loadingSteps.length) {
        const loadingText = document.querySelector('.loading-text');
        if (loadingText) {
          loadingText.textContent = loadingSteps[currentStep].text;
        }
        
        setTimeout(() => {
          currentStep++;
          if (currentStep >= loadingSteps.length) {
            clearInterval(textInterval);
          }
        }, loadingSteps[currentStep]?.duration || 0);
      }
    }, 100);
  }
  
  updateProgress() {
    if (this.progressElement) {
      this.progressElement.style.width = this.progress + '%';
    }
    
    if (this.percentageElement) {
      this.percentageElement.textContent = Math.round(this.progress) + '%';
    }
  }
  
  complete() {
    if (this.isComplete) return;
    this.isComplete = true;
    
    // Fade out splash screen
    this.splashElement.classList.add('fade-out');
    
    // Show main application
    setTimeout(() => {
      document.querySelector('.app').classList.add('loaded');
      document.querySelector('.layout-toggle').classList.add('loaded');
      
      // Remove splash screen from DOM
      setTimeout(() => {
        if (this.splashElement.parentNode) {
          this.splashElement.parentNode.removeChild(this.splashElement);
        }
      }, 800);
    }, 400);
    
    console.log('üéµ SynthBat Studio carregado com sucesso!');
  }
}

// Initialize splash screen
const splash = new SplashScreen();

// --- Rhythm Patches System ---
const rhythmPatches = {
  funk: {
    bpm: 110,
    patterns: {
      kick: [true, false, false, false, false, false, true, false, false, false, false, false, true, false, false, false, true, false, false, false, false, false, true, false, false, false, false, false, true, false, false, false],
      snare: [false, false, false, false, true, false, false, false, false, false, false, false, true, false, false, false, false, false, false, false, true, false, false, false, false, false, false, false, true, false, false, false],
      hat: [true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false],
      openhat: [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, true, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, true],
      crash: [true, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, true, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false],
      piano: [true, false, false, true, false, false, true, false, false, true, false, false, true, false, false, false, true, false, false, true, false, false, true, false, false, true, false, false, true, false, false, false],
      bass: [true, false, false, false, false, false, true, false, true, false, false, false, false, false, false, false, true, false, false, false, false, false, true, false, true, false, false, false, false, false, false, false],
      lead: [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false]
    }
  },
  rock: {
    bpm: 140,
    patterns: {
      kick: [true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false],
      snare: [false, false, false, false, true, false, false, false, false, false, false, false, true, false, false, false, false, false, false, false, true, false, false, false, false, false, false, false, true, false, false, false],
      hat: [true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false],
      openhat: [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false],
      crash: [true, false, false, false, false, false, false, false, true, false, false, false, false, false, false, false, true, false, false, false, false, false, false, false, true, false, false, false, false, false, false, false],
      piano: [true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false],
      bass: [true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false],
      lead: [true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false]
    }
  },
  pop: {
    bpm: 128,
    patterns: {
      kick: [true, false, false, false, false, false, false, false, true, false, false, false, false, false, false, false, true, false, false, false, false, false, false, false, true, false, false, false, false, false, false, false],
      snare: [false, false, false, false, true, false, false, false, false, false, false, false, true, false, false, false, false, false, false, false, true, false, false, false, false, false, false, false, true, false, false, false],
      hat: [false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false],
      openhat: [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false],
      crash: [true, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, true, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false],
      piano: [true, false, false, true, false, false, false, false, true, false, false, true, false, false, false, false, true, false, false, true, false, false, false, false, true, false, false, true, false, false, false, false],
      bass: [true, false, false, false, false, false, false, false, true, false, false, false, false, false, false, false, true, false, false, false, false, false, false, false, true, false, false, false, false, false, false, false],
      lead: [true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false]
    }
  },
  trap: {
    bpm: 140,
    patterns: {
      kick: [true, false, false, false, false, false, false, false, false, false, false, false, true, false, false, false, true, false, false, false, false, false, false, false, false, false, false, false, true, false, false, false],
      snare: [false, false, false, false, true, false, false, true, false, false, true, false, false, false, true, false, false, false, false, false, true, false, false, true, false, false, true, false, false, false, true, false],
      hat: [true, true, false, true, true, true, false, true, true, true, false, true, true, true, false, true, true, true, false, true, true, true, false, true, true, true, false, true, true, true, false, true],
      openhat: [false, false, false, false, false, false, true, false, false, false, false, false, false, false, true, false, false, false, false, false, false, false, true, false, false, false, false, false, false, false, true, false],
      crash: [true, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, true, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false],
      piano: [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false],
      bass: [true, false, false, false, false, false, false, false, false, false, false, false, true, false, false, false, true, false, false, false, false, false, false, false, false, false, false, false, true, false, false, false],
      lead: [true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false]
    }
  },
  house: {
    bpm: 124,
    patterns: {
      kick: [true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false],
      snare: [false, false, false, false, true, false, false, false, false, false, false, false, true, false, false, false, false, false, false, false, true, false, false, false, false, false, false, false, true, false, false, false],
      hat: [false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false],
      openhat: [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, true, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, true],
      crash: [true, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, true, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false],
      piano: [true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false],
      bass: [true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false],
      lead: [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false]
    }
  },
  reggae: {
    bpm: 90,
    patterns: {
      kick: [false, false, true, false, false, false, false, false, false, false, true, false, false, false, false, false, false, false, true, false, false, false, false, false, false, false, true, false, false, false, false, false],
      snare: [false, false, false, false, true, false, false, false, false, false, false, false, true, false, false, false, false, false, false, false, true, false, false, false, false, false, false, false, true, false, false, false],
      hat: [true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false],
      openhat: [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false],
      crash: [true, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, true, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false],
      piano: [false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false],
      bass: [false, false, true, false, false, false, false, false, false, false, true, false, false, false, false, false, false, false, true, false, false, false, false, false, false, false, true, false, false, false, false, false],
      lead: [true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false]
    }
  }
};

// Initialize patch controls
function initPatchControls() {
  // Patches toggle
  const patchesToggle = document.getElementById('patchesToggle');
  const patchGrid = document.getElementById('patchGrid');
  
  patchesToggle.addEventListener('click', () => {
    const isCollapsed = patchGrid.classList.contains('collapsed');
    
    if (isCollapsed) {
      patchGrid.classList.remove('collapsed');
      patchesToggle.textContent = '‚ñº';
      patchesToggle.classList.remove('collapsed');
    } else {
      patchGrid.classList.add('collapsed');
      patchesToggle.textContent = '‚ñ∂';
      patchesToggle.classList.add('collapsed');
    }
  });
  
  // Patch buttons
  document.querySelectorAll('.patch-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const patchName = btn.dataset.patch;
      loadRhythmPatch(patchName);
      
      // Visual feedback
      document.querySelectorAll('.patch-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      // Show notification
      showPatchNotification(patchName);
    });
  });
}

function loadRhythmPatch(patchName) {
  const patch = rhythmPatches[patchName];
  if (!patch) {
    console.error('Patch n√£o encontrado:', patchName);
    return;
  }
  
  // Stop current playback
  if (sequencer.playing) {
    stopSequencer();
  }
  
  // Set BPM
  sequencer.bpm = patch.bpm;
  seqBpmSlider.value = patch.bpm;
  seqBpmDisplay.textContent = patch.bpm;
  
  // Load patterns
  sequencer.tracks.forEach(track => {
    if (patch.patterns[track.sound]) {
      track.pattern = [...patch.patterns[track.sound]];
    } else {
      track.pattern.fill(false);
    }
  });
  
  // Refresh UI
  initSequencer();
  
  console.log(`üéº Patch "${patchName.toUpperCase()}" carregado! BPM: ${patch.bpm}`);
}

function showPatchNotification(patchName) {
  // Create notification element
  const notification = document.createElement('div');
  notification.className = 'patch-notification';
  notification.innerHTML = `
    <div class="patch-notification-content">
      üéº <strong>${patchName.toUpperCase()}</strong> carregado!
    </div>
  `;
  
  // Style the notification
  Object.assign(notification.style, {
    position: 'fixed',
    top: '20px',
    left: '50%',
    transform: 'translateX(-50%)',
    background: 'linear-gradient(135deg, var(--accent), #00d2ff)',
    color: '#fff',
    padding: '12px 24px',
    borderRadius: '25px',
    fontWeight: '600',
    fontSize: '14px',
    zIndex: '10003',
    boxShadow: '0 8px 25px rgba(31,182,255,0.4)',
    animation: 'slideInDown 0.3s ease, slideOutUp 0.3s ease 2s',
    backdropFilter: 'blur(10px)'
  });
  
  // Add to page
  document.body.appendChild(notification);
  
  // Remove after animation
  setTimeout(() => {
    if (document.body.contains(notification)) {
      document.body.removeChild(notification);
    }
  }, 2500);
}

// Add CSS animations for notifications
const notificationStyles = document.createElement('style');
notificationStyles.textContent = `
  @keyframes slideInDown {
    0% {
      transform: translateX(-50%) translateY(-100px);
      opacity: 0;
    }
    100% {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
  }
  
  @keyframes slideOutUp {
    0% {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    100% {
      transform: translateX(-50%) translateY(-100px);
      opacity: 0;
    }
  }
`;
document.head.appendChild(notificationStyles);

// Initialize patch controls when page loads
initPatchControls();

// --- Layout Toggle Functionality ---
const layoutToggle = document.getElementById('layoutToggle');
const appContainer = document.getElementById('appContainer');

layoutToggle.addEventListener('click', () => {
  const isMultiColumn = appContainer.classList.contains('multi-column');
  
  if (isMultiColumn) {
    // Switch to single column (centered)
    appContainer.classList.remove('multi-column');
    layoutToggle.textContent = 'üìã LINHA √öNICA';
    showLayoutChangeNotification('Linha √∫nica ativada - Cards centralizados');
  } else {
    // Switch to multi-column
    appContainer.classList.add('multi-column');
    layoutToggle.textContent = 'üìä M√öLTIPLAS COLUNAS';
    showLayoutChangeNotification('M√∫ltiplas colunas ativadas - Layout flex√≠vel');
  }
  
  // Save layout preference
  localStorage.setItem('synthbat_layout_mode', isMultiColumn ? 'single' : 'multi');
});

// Load saved layout mode
function loadLayoutMode() {
  const savedMode = localStorage.getItem('synthbat_layout_mode');
  if (savedMode === 'multi') {
    appContainer.classList.add('multi-column');
    layoutToggle.textContent = 'üìä M√öLTIPLAS COLUNAS';
  } else {
    appContainer.classList.remove('multi-column');
    layoutToggle.textContent = 'üìã LINHA √öNICA';
  }
}

function showLayoutChangeNotification(message) {
  const notification = document.createElement('div');
  notification.className = 'layout-change-notification';
  notification.innerHTML = `
    <div class="notification-content">
      üîß ${message}
    </div>
  `;
  
  // Style the notification
  Object.assign(notification.style, {
    position: 'fixed',
    top: '70px',
    right: '20px',
    background: 'linear-gradient(135deg, var(--success), #27ae60)',
    color: '#fff',
    padding: '12px 16px',
    borderRadius: '8px',
    fontWeight: '600',
    fontSize: '13px',
    zIndex: '10005',
    boxShadow: '0 4px 15px rgba(46,213,115,0.4)',
    animation: 'slideInRight 0.3s ease, slideOutRight 0.3s ease 2.5s',
    backdropFilter: 'blur(10px)'
  });
  
  // Add to page
  document.body.appendChild(notification);
  
  // Remove after animation
  setTimeout(() => {
    if (document.body.contains(notification)) {
      document.body.removeChild(notification);
    }
  }, 3000);
}

// Add CSS animations for layout notifications
const layoutNotificationStyles = document.createElement('style');
layoutNotificationStyles.textContent = `
  @keyframes slideInRight {
    0% {
      transform: translateX(100px);
      opacity: 0;
    }
    100% {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  @keyframes slideOutRight {
    0% {
      transform: translateX(0);
      opacity: 1;
    }
    100% {
      transform: translateX(100px);
      opacity: 0;
    }
  }
`;
document.head.appendChild(layoutNotificationStyles);

// Load layout mode on startup
loadLayoutMode();

// --- Column Resizing Functionality ---
class ColumnResizer {
  constructor() {
    this.isResizing = false;
    this.currentColumn = null;
    this.startX = 0;
    this.startWidth = 0;
    this.init();
  }

  init() {
    // Add event listeners to column resizers
    document.querySelectorAll('.column-resizer').forEach(resizer => {
      resizer.addEventListener('mousedown', (e) => this.startResize(e));
      resizer.addEventListener('touchstart', (e) => this.startResize(e), {passive: false});
    });

    // Global mouse events
    document.addEventListener('mousemove', (e) => this.doResize(e));
    document.addEventListener('mouseup', () => this.stopResize());
    document.addEventListener('touchmove', (e) => this.doResize(e), {passive: false});
    document.addEventListener('touchend', () => this.stopResize());
  }

  startResize(e) {
    e.preventDefault();
    this.isResizing = true;
    
    const resizer = e.target;
    const columnId = resizer.dataset.column;
    this.currentColumn = document.getElementById(`column${columnId}`);
    
    // Get starting position
    const clientX = e.clientX || (e.touches && e.touches[0].clientX);
    this.startX = clientX;
    this.startWidth = this.currentColumn.offsetWidth;
    
    // Add visual feedback
    resizer.classList.add('dragging');
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
    
    // Add overlay to prevent iframe interference
    this.addResizeOverlay();
  }

  doResize(e) {
    if (!this.isResizing || !this.currentColumn) return;
    
    e.preventDefault();
    
    const clientX = e.clientX || (e.touches && e.touches[0].clientX);
    const deltaX = clientX - this.startX;
    const newWidth = this.startWidth + deltaX;
    
    // Set minimum and maximum widths
    const minWidth = 250;
    const maxWidth = window.innerWidth * 0.7;
    const constrainedWidth = Math.max(minWidth, Math.min(maxWidth, newWidth));
    
    // Apply new width
    this.currentColumn.style.width = constrainedWidth + 'px';
    
    // Update table layout
    const app = document.getElementById('appContainer');
    app.style.tableLayout = 'auto';
  }

  stopResize() {
    if (!this.isResizing) return;
    
    this.isResizing = false;
    this.currentColumn = null;
    
    // Remove visual feedback
    document.querySelectorAll('.column-resizer').forEach(resizer => {
      resizer.classList.remove('dragging');
    });
    
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
    
    // Remove overlay
    this.removeResizeOverlay();
    
    // Save column widths
    this.saveColumnWidths();
  }

  addResizeOverlay() {
    const overlay = document.createElement('div');
    overlay.id = 'resize-overlay';
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 10000;
      cursor: col-resize;
      background: transparent;
    `;
    document.body.appendChild(overlay);
  }

  removeResizeOverlay() {
    const overlay = document.getElementById('resize-overlay');
    if (overlay) {
      document.body.removeChild(overlay);
    }
  }

  saveColumnWidths() {
    const widths = {
      column1: document.getElementById('column1').offsetWidth,
      column2: document.getElementById('column2').offsetWidth,
      column3: document.getElementById('column3').offsetWidth
    };
    localStorage.setItem('synthbat_column_widths', JSON.stringify(widths));
  }

  loadColumnWidths() {
    const saved = localStorage.getItem('synthbat_column_widths');
    if (!saved) return;
    
    try {
      const widths = JSON.parse(saved);
      
      Object.keys(widths).forEach(columnId => {
        const column = document.getElementById(columnId);
        if (column && widths[columnId]) {
          column.style.width = widths[columnId] + 'px';
        }
      });
      
      // Set table layout to auto to respect custom widths
      const app = document.getElementById('appContainer');
      app.style.tableLayout = 'auto';
      
      console.log('üìê Larguras das colunas restauradas');
    } catch (error) {
      console.error('Erro ao carregar larguras das colunas:', error);
    }
  }
}

// Initialize column resizing
const columnResizer = new ColumnResizer();

// Load saved column widths after a short delay to ensure DOM is ready
setTimeout(() => {
  columnResizer.loadColumnWidths();
}, 100);

// Initialize XY Patch Controls on load
initXYPatchControls();

// Update XY coordinates display on mouse leave canvas
xyCanvas.addEventListener('mouseleave', () => {
  document.getElementById('xCoord').textContent = '0.0';
  document.getElementById('yCoord').textContent = '0.0';
  pointer = null;
  drawGuide();
});

// Final note: friendly help
console.log('üéµ SynthBat Studio com Patches de Ritmo carregado! üéµ');
console.log('- 18 instrumentos musicais coloridos');
console.log('- Sequenciador de 32 steps com 8 trilhas');
console.log('- 6 patches de ritmo pr√©-configurados (Funk, Rock, Pop, Trap, House, Reggae)');
console.log('- Grava√ß√£o de √°udio em tempo real');
console.log('- Salvamento/carregamento de sequ√™ncias');
console.log('- √Årea XY para controle em tempo real com patches musicais');
console.log('- Controles expandidos: tonalidade, escala, velocidade, efeitos');
console.log('- 6 presets de patch: Lead, Bass, Pad, Pluck, Ambient, Aggressive');
console.log('- Interface drag-and-drop personaliz√°vel');
console.log('- Cards recolh√≠veis para organizar o espa√ßo');
console.log('- Layout salvo automaticamente no navegador');
console.log('Divirta-se criando m√∫sica! üé∂üéõÔ∏èüì±üéº');
console.log('');
console.log('üí° Dicas:');
console.log('‚Ä¢ Use o pad XY para tocar notas em escalas musicais');
console.log('‚Ä¢ Experimente os presets de patch para diferentes timbres');
console.log('‚Ä¢ Ajuste efeitos em tempo real com os sliders');
console.log('‚Ä¢ Grave seu performance com o sequenciador');
console.log('‚Ä¢ Clique nos patch presets para carregar configura√ß√µes');
</script>
</body>
</html>
