<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sintetizador + Bateria Virtual — Demo</title>
  <style>
    :root{--bg:#0b1220;--card:#0f1724;--accent:#1fb6ff;--muted:#98a0b3;--success:#2ed573;--danger:#ff4757;--warning:#ffa502}
    
    * { box-sizing: border-box; }
    
    html,body{height:100%;margin:0;font-family:'Inter',system-ui,-apple-system,Arial,sans-serif;color:#e6eef8;background:linear-gradient(180deg,#071029 0%, #071b2f 100%);line-height:1.5}
    
    .app{max-width:1800px;margin:20px auto;padding:20px;display:grid;grid-template-columns:1fr;gap:20px}
    
    @media (min-width: 1024px) {
      .app { grid-template-columns: 500px 1fr; }
    }
    
    @media (min-width: 1400px) {
      .app { grid-template-columns: 600px 1fr; }
    }
    
    .card{
      background:rgba(255,255,255,0.05);
      border-radius:16px;
      padding:20px;
      box-shadow:0 8px 32px rgba(2,6,23,0.4);
      border:1px solid rgba(255,255,255,0.08);
      backdrop-filter:blur(10px);
    }
    
    .card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:20px;
      padding-bottom:12px;
      border-bottom:1px solid rgba(255,255,255,0.1);
    }
    
    .card-title{
      font-size:20px;
      font-weight:700;
      color:#fff;
      margin:0;
      display:flex;
      align-items:center;
      gap:8px;
    }
    
    .card-subtitle{
      font-size:14px;
      color:var(--muted);
      margin:8px 0 0 0;
    }
    
    .section{
      margin-bottom:24px;
    }
    
    .section:last-child{
      margin-bottom:0;
    }
    
    .section-title{
      font-size:16px;
      font-weight:600;
      margin-bottom:12px;
      color:var(--accent);
      text-transform:uppercase;
      letter-spacing:0.5px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    
    .pads-table{
      width:100%;
      border-collapse:separate;
      border-spacing:8px;
    }
    
    .pads-table td{
      padding:0;
      vertical-align:top;
    }
    
    .pad{
      width:100%;
      background:linear-gradient(135deg,rgba(255,255,255,0.1),rgba(255,255,255,0.05));
      border:1px solid rgba(255,255,255,0.15);
      padding:12px 8px;
      border-radius:12px;
      cursor:pointer;
      user-select:none;
      text-align:center;
      font-size:11px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.5px;
      transition:all 0.2s ease;
      min-height:48px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    
    .pad:hover{
      transform:translateY(-2px);
      box-shadow:0 6px 20px rgba(0,0,0,0.3);
      border-color:rgba(255,255,255,0.3);
    }
    
    .pad:active{
      transform:translateY(1px);
      transition:transform 0.05s ease;
    }
    
    /* Drum pad colors */
    .pad-kick{background:linear-gradient(135deg,#ff4757,#ff3838);color:white;border:1px solid #ff3838}
    .pad-snare{background:linear-gradient(135deg,#ffa502,#ff6348);color:white;border:1px solid #ff6348}
    .pad-hat{background:linear-gradient(135deg,#70a1ff,#5352ed);color:white;border:1px solid #5352ed}
    .pad-crash{background:linear-gradient(135deg,#7bed9f,#2ed573);color:white;border:1px solid #2ed573}
    .pad-ride{background:linear-gradient(135deg,#dda0dd,#9b59b6);color:white;border:1px solid #9b59b6}
    .pad-tom{background:linear-gradient(135deg,#ffb8b8,#ff7675);color:white;border:1px solid #ff7675}
    .pad-openhat{background:linear-gradient(135deg,#74b9ff,#0984e3);color:white;border:1px solid #0984e3}
    .pad-clap{background:linear-gradient(135deg,#fd79a8,#e84393);color:white;border:1px solid #e84393}
    .pad-perc{background:linear-gradient(135deg,#fdcb6e,#e17055);color:white;border:1px solid #e17055}
    
    /* Melodic instrument colors */
    .pad-piano{background:linear-gradient(135deg,#636e72,#2d3436);color:white;border:1px solid #2d3436}
    .pad-bass{background:linear-gradient(135deg,#a29bfe,#6c5ce7);color:white;border:1px solid #6c5ce7}
    .pad-lead{background:linear-gradient(135deg,#fd79a8,#e84393);color:white;border:1px solid #e84393}
    .pad-pad{background:linear-gradient(135deg,#00cec9,#00b894);color:white;border:1px solid #00b894}
    .pad-pluck{background:linear-gradient(135deg,#fab1a0,#e17055);color:white;border:1px solid #e17055}
    .pad-organ{background:linear-gradient(135deg,#55a3ff,#2d3436);color:white;border:1px solid #2d3436}
    
    /* Effect colors */
    .pad-fx{background:linear-gradient(135deg,#a29bfe,#74b9ff);color:white;border:1px solid #74b9ff}
    .pad-noise{background:linear-gradient(135deg,#636e72,#2d3436);color:white;border:1px solid #2d3436}
    .pad-sweep{background:linear-gradient(135deg,#00b894,#00cec9);color:white;border:1px solid #00cec9}
    
    /* Controls and buttons */
    .controls-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:16px;
    }
    
    @media (min-width: 768px) {
      .controls-grid { grid-template-columns: 1fr 1fr; }
    }
    
    .control-group{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    
    .control-row{
      display:flex;
      align-items:center;
      gap:12px;
    }
    
    .control-label{
      font-size:12px;
      color:var(--muted);
      min-width:80px;
      font-weight:500;
    }
    
    .btn-group{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    
    .btn{
      background:var(--accent);
      border:none;
      color:#022233;
      padding:10px 16px;
      border-radius:8px;
      cursor:pointer;
      font-size:13px;
      font-weight:600;
      transition:all 0.2s ease;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(31,182,255,0.3);
    }
    
    .btn.danger{background:var(--danger)}
    .btn.success{background:var(--success)}
    .btn.muted{background:transparent;border:2px solid rgba(255,255,255,0.15);color:var(--muted)}
    
    /* Sequencer styles */
    .sequencer-container{
      background:rgba(0,0,0,0.3);
      border-radius:12px;
      padding:16px;
      overflow-x:auto;
      position:relative;
    }
    
    .sequencer-grid{
      position:relative;
      width:100%;
    }
    
    .sequencer-table{
      width:100%;
      min-width:900px;
      border-collapse:separate;
      border-spacing:2px;
      background:rgba(0,0,0,0.2);
      border-radius:8px;
    }
    
    .sequencer-table th{
      background:linear-gradient(135deg, rgba(31,182,255,0.15), rgba(31,182,255,0.08));
      color:var(--accent);
      padding:10px 6px;
      text-align:center;
      font-size:11px;
      border-radius:6px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.5px;
      border:1px solid rgba(31,182,255,0.2);
    }
    
    .sequencer-table th:first-child{
      background:linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
      color:#fff;
      font-size:12px;
      min-width:100px;
      max-width:100px;
    }
    
    .sequencer-table tbody tr{
      background:rgba(255,255,255,0.02);
    }
    
    .sequencer-table tbody tr:nth-child(odd){
      background:rgba(255,255,255,0.04);
    }
    
    .track-name-cell{
      background:linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04)) !important;
      color:#fff;
      padding:12px 16px;
      font-size:11px;
      border-radius:6px;
      font-weight:700;
      text-align:center;
      text-transform:uppercase;
      letter-spacing:0.5px;
      border:1px solid rgba(255,255,255,0.1);
      min-width:100px;
      max-width:100px;
    }
    
    .step-cell{
      background:linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      border:2px solid rgba(255,255,255,0.1);
      width:32px;
      height:32px;
      cursor:pointer;
      border-radius:8px;
      position:relative;
      transition:all 0.2s ease;
      text-align:center;
      vertical-align:middle;
    }
    
    .step-cell:hover{
      border-color:var(--accent);
      background:rgba(31,182,255,0.1);
    }
    
    .step-cell.active{
      background:var(--accent);
      border-color:var(--accent);
      box-shadow:0 0 10px rgba(31,182,255,0.5);
    }
    
    .step-cell.current{
      border-color:#fff;
      box-shadow:0 0 15px rgba(255,255,255,0.8);
      animation:currentStep 0.6s ease-in-out;
    }
    
    @keyframes currentStep{
      0%,100%{transform:scale(1)}
      50%{transform:scale(1.1)}
    }
    
    .playhead{
      position:absolute;
      top:20px;
      bottom:20px;
      width:3px;
      background:linear-gradient(180deg, #fff, var(--accent));
      border-radius:2px;
      transition:left 0.15s ease;
      z-index:10;
      box-shadow:0 0 15px rgba(255,255,255,0.8),
                  0 0 30px rgba(31,182,255,0.4);
      pointer-events:none;
    }
    
    .seq-controls{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:16px;
    }
    
    .seq-btn{
      background:var(--accent);
      border:none;
      color:#022233;
      padding:8px 14px;
      border-radius:8px;
      cursor:pointer;
      font-size:12px;
      font-weight:600;
      transition:all 0.2s ease;
      text-transform:uppercase;
    }
    
    .seq-btn.danger{background:var(--danger)}
    .seq-btn.success{background:var(--success)}
    .seq-btn.recording{
      background:var(--danger);
      animation:pulse 1.2s ease-in-out infinite;
    }
    
    @keyframes pulse{
      0%,100%{opacity:1;transform:scale(1)}
      50%{opacity:0.8;transform:scale(1.05)}
    }
    
    .bpm-control{
      display:flex;
      align-items:center;
      gap:8px;
      margin-left:16px;
    }
    
    .bpm-display{
      font-size:12px;
      color:var(--muted);
      font-weight:600;
    }
    /* XY Canvas */
    #xyCanvas{
      width:100%;
      height:400px;
      background:linear-gradient(135deg,#071b2f,#04202a,#051a28);
      border-radius:16px;
      touch-action:none;
      border:2px solid rgba(255,255,255,0.1);
      box-shadow:inset 0 4px 20px rgba(0,0,0,0.3);
    }
    
    @media (min-width: 768px) {
      #xyCanvas { height: 450px; }
    }
    
    /* Form elements */
    input[type=range]{
      -webkit-appearance:none;
      height:8px;
      background:rgba(255,255,255,0.1);
      border-radius:4px;
      outline:none;
      flex:1;
      min-width:100px;
    }
    
    input[type=range]::-webkit-slider-thumb{
      -webkit-appearance:none;
      width:20px;
      height:20px;
      background:var(--accent);
      border-radius:50%;
      cursor:pointer;
      box-shadow:0 2px 8px rgba(31,182,255,0.4);
    }
    
    select{
      background:rgba(255,255,255,0.1);
      border:2px solid rgba(255,255,255,0.15);
      color:#fff;
      padding:8px 12px;
      border-radius:8px;
      font-size:13px;
    }
    
    .xy-info{
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:16px;
      margin-top:16px;
    }
    
    .meta{
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }
    
    .preset-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));
      gap:8px;
    }
    
    .preset{
      background:rgba(255,255,255,0.05);
      padding:10px 12px;
      border-radius:8px;
      border:2px solid rgba(255,255,255,0.1);
      cursor:pointer;
      text-align:center;
      font-size:12px;
      font-weight:500;
      transition:all 0.2s ease;
    }
    
    .preset:hover{
      border-color:var(--accent);
      background:rgba(31,182,255,0.1);
      transform:translateY(-1px);
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .app { padding: 12px; margin: 10px auto; }
      .card { padding: 16px; }
      .card-title { font-size: 18px; }
      .section-title { font-size: 14px; }
      .timeline-container { padding: 12px; }
      .seq-controls { gap: 6px; }
      .seq-btn { padding: 6px 10px; font-size: 11px; }
      #xyCanvas { height: 300px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Left Panel: Controls -->
    <div class="card">
      <div class="card-header">
        <div>
          <h1 class="card-title">🎵 SynthBat Studio</h1>
          <p class="card-subtitle">Sintetizador e Sequenciador Musical</p>
        </div>
      </div>

      <!-- Drum Pads Section -->
      <div class="section">
        <div class="section-title">🥁 Bateria</div>
        <table class="pads-table">
          <tr>
            <td><div class="pad pad-kick" data-pad="kick">KICK</div></td>
            <td><div class="pad pad-snare" data-pad="snare">SNARE</div></td>
            <td><div class="pad pad-hat" data-pad="hat">HI-HAT</div></td>
          </tr>
          <tr>
            <td><div class="pad pad-openhat" data-pad="openhat">OPEN HAT</div></td>
            <td><div class="pad pad-crash" data-pad="crash">CRASH</div></td>
            <td><div class="pad pad-ride" data-pad="ride">RIDE</div></td>
          </tr>
          <tr>
            <td><div class="pad pad-tom" data-pad="tom">TOM</div></td>
            <td><div class="pad pad-clap" data-pad="clap">CLAP</div></td>
            <td><div class="pad pad-perc" data-pad="perc">PERC</div></td>
          </tr>
        </table>
      </div>
      
      <!-- Instruments Section -->
      <div class="section">
        <div class="section-title">🎹 Instrumentos</div>
        <table class="pads-table">
          <tr>
            <td><div class="pad pad-piano" data-pad="piano">PIANO</div></td>
            <td><div class="pad pad-bass" data-pad="bass">BASS</div></td>
            <td><div class="pad pad-lead" data-pad="lead">LEAD</div></td>
          </tr>
          <tr>
            <td><div class="pad pad-pad" data-pad="synthpad">PAD</div></td>
            <td><div class="pad pad-pluck" data-pad="pluck">PLUCK</div></td>
            <td><div class="pad pad-organ" data-pad="organ">ORGAN</div></td>
          </tr>
        </table>
      </div>
      
      <!-- Effects Section -->
      <div class="section">
        <div class="section-title">🎛️ Efeitos</div>
        <table class="pads-table">
          <tr>
            <td><div class="pad pad-fx" data-pad="reverse">REVERSE</div></td>
            <td><div class="pad pad-sweep" data-pad="sweep">SWEEP</div></td>
            <td><div class="pad pad-noise" data-pad="whitenoise">NOISE</div></td>
          </tr>
        </table>
      </div>
      
      <!-- Controls Section -->
      <div class="section">
        <div class="section-title">⚙️ Controles Globais</div>
        <div class="controls-grid">
          <div class="control-group">
            <div class="control-row">
              <span class="control-label">BPM</span>
              <input id="bpm" type="range" min="40" max="200" value="100" />
            </div>
            <div class="control-row">
              <span class="control-label">Volume</span>
              <input id="masterVol" type="range" min="0" max="1" step="0.01" value="0.9" />
            </div>
            <div class="control-row">
              <span class="control-label">Pitch</span>
              <input id="pitchRange" type="range" min="0.2" max="3" step="0.01" value="1.5" />
            </div>
          </div>
          <div class="control-group">
            <div class="btn-group">
              <button id="startStop" class="btn">Start</button>
              <button id="metroToggle" class="btn muted">Metrônomo</button>
              <button id="savePreset" class="btn muted">Salvar Preset</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Presets Section -->
      <div class="section">
        <div class="section-title">💾 Presets</div>
        <div class="preset-grid" id="presets"></div>
      </div>
    </div>

    <!-- Right Panel: XY Pad & Sequencer -->
    <div class="card">
      <!-- XY Pad Section -->
      <div class="section">
        <div class="card-header">
          <div>
            <h2 class="card-title">🎚️ Controle XY</h2>
            <p class="card-subtitle">Área de controle em tempo real</p>
          </div>
        </div>
        
        <canvas id="xyCanvas"></canvas>
        
        <div class="xy-info">
          <div class="meta">Eixo X: variação entre timbres • Eixo Y: pitch/volume</div>
          <div class="control-row">
            <span class="control-label">Modo:</span>
            <select id="mode">
              <option value="sampleBlend">Misturar Samples</option>
              <option value="oscillator">Oscilador</option>
              <option value="drumMorph">Morph Bateria</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- Sequencer Section -->
      <div class="section">
        <div class="section-title">🎵 Sequenciador (16 Steps)</div>
        
        <div class="seq-controls">
          <button id="seqPlay" class="seq-btn">▶ PLAY</button>
          <button id="seqStop" class="seq-btn danger">⏹ STOP</button>
          <button id="seqRecord" class="seq-btn success">⏺ GRAVAR</button>
          <button id="seqClear" class="seq-btn">🗑 LIMPAR</button>
          <button id="seqSave" class="seq-btn">💾 SALVAR</button>
          <button id="seqLoad" class="seq-btn">📁 CARREGAR</button>
          
          <div class="bpm-control">
            <span class="bpm-display">Tempo: <span id="seqBpm">120</span> BPM</span>
            <input id="seqBpmSlider" type="range" min="60" max="180" value="120">
          </div>
        </div>
        
        <div class="sequencer-container">
          <div class="sequencer-grid">
            <table class="sequencer-table" id="sequencerTable">
              <!-- Tabela será gerada dinamicamente -->
            </table>
            <div class="playhead" id="playhead"></div>
          </div>
        </div>
        
        <div class="meta" style="margin-top:12px;">
          💡 Dica: Clique nos pads em modo GRAVAR para adicionar à trilha, ou clique diretamente nas células para programar beats
        </div>
      </div>
    </div>
  </div>

<script>
// --- Setup WebAudio ---
const AudioContext = window.AudioContext || window.webkitAudioContext;
const ctx = new AudioContext();
let masterGain = ctx.createGain(); masterGain.gain.value = 0.9; masterGain.connect(ctx.destination);

// Basic utilities
function now(){return ctx.currentTime}

// State
const state = {
  bpm:100, playing:false, metro:false,
  pitchRange:1.5, masterVol:0.9,
  mode:'sampleBlend'
}

// Sequencer state
const sequencer = {
  bpm: 120,
  playing: false,
  recording: false,
  currentStep: 0,
  steps: 16,
  tracks: [
    {name: 'KICK', sound: 'kick', pattern: new Array(16).fill(false)},
    {name: 'SNARE', sound: 'snare', pattern: new Array(16).fill(false)},
    {name: 'HAT', sound: 'hat', pattern: new Array(16).fill(false)},
    {name: 'OPEN HAT', sound: 'openhat', pattern: new Array(16).fill(false)},
    {name: 'CRASH', sound: 'crash', pattern: new Array(16).fill(false)},
    {name: 'PIANO', sound: 'piano', pattern: new Array(16).fill(false)},
    {name: 'BASS', sound: 'bass', pattern: new Array(16).fill(false)},
    {name: 'LEAD', sound: 'lead', pattern: new Array(16).fill(false)}
  ],
  interval: null,
  audioRecorder: null,
  recordedChunks: [],
  mediaRecorder: null
}

// Wire controls
const bpmSlider = document.getElementById('bpm');
const masterVol = document.getElementById('masterVol');
const pitchRange = document.getElementById('pitchRange');
const startStopBtn = document.getElementById('startStop');
const metroToggle = document.getElementById('metroToggle');
const xyCanvas = document.getElementById('xyCanvas');
const modeSel = document.getElementById('mode');

bpmSlider.addEventListener('input',()=>{state.bpm=+bpmSlider.value});
masterVol.addEventListener('input',()=>{state.masterVol=+masterVol.value; masterGain.gain.setValueAtTime(state.masterVol, now());});
pitchRange.addEventListener('input',()=>{state.pitchRange=+pitchRange.value});
modeSel.addEventListener('change',()=>{state.mode=modeSel.value; drawGuide();});

// Sequencer controls
const seqBpmSlider = document.getElementById('seqBpmSlider');
const seqBpmDisplay = document.getElementById('seqBpm');
const seqPlayBtn = document.getElementById('seqPlay');
const seqStopBtn = document.getElementById('seqStop');
const seqRecordBtn = document.getElementById('seqRecord');
const seqClearBtn = document.getElementById('seqClear');
const seqSaveBtn = document.getElementById('seqSave');
const seqLoadBtn = document.getElementById('seqLoad');

seqBpmSlider.addEventListener('input', () => {
  sequencer.bpm = +seqBpmSlider.value;
  seqBpmDisplay.textContent = sequencer.bpm;
});

seqPlayBtn.addEventListener('click', () => sequencer.playing ? stopSequencer() : startSequencer());
seqStopBtn.addEventListener('click', stopSequencer);
seqRecordBtn.addEventListener('click', toggleRecording);
seqClearBtn.addEventListener('click', clearSequencer);
seqSaveBtn.addEventListener('click', saveSequence);
seqLoadBtn.addEventListener('click', loadSequence);

startStopBtn.addEventListener('click',()=>{ if(!state.playing){ startTransport(); } else { stopTransport(); } });
metroToggle.addEventListener('click',()=>{ state.metro = !state.metro; metroToggle.style.opacity = state.metro?1:0.6; });

// --- Drum pads synthesis ---
function playKick(time){
  const g = ctx.createGain(); g.gain.value = 1; g.connect(masterGain);
  const o = ctx.createOscillator(); o.type='sine'; o.frequency.setValueAtTime(150, time);
  o.frequency.exponentialRampToValueAtTime(40, time+0.5);
  g.gain.setValueAtTime(0.0001, time);
  g.gain.exponentialRampToValueAtTime(1.2, time+0.001);
  g.gain.exponentialRampToValueAtTime(0.001, time+0.6);
  o.connect(g); o.start(time); o.stop(time+0.7);
}

function playSnare(time){
  const noise = ctx.createBufferSource();
  noise.buffer = makeNoiseBuffer();
  const nFilter = ctx.createBiquadFilter(); nFilter.type='highpass'; nFilter.frequency.value = 1000;
  const g = ctx.createGain(); g.gain.value=1; g.connect(masterGain);
  noise.connect(nFilter); nFilter.connect(g);
  g.gain.setValueAtTime(1, time); g.gain.exponentialRampToValueAtTime(0.01, time+0.4);
  noise.start(time); noise.stop(time+0.5);
}

function playHat(time){
  const o = ctx.createOscillator(); o.type='square'; o.frequency.value=8000;
  const g = ctx.createGain(); g.gain.value=0.0001; g.connect(masterGain);
  o.connect(g); o.start(time);
  g.gain.setValueAtTime(0.0001, time); g.gain.exponentialRampToValueAtTime(0.6, time+0.001); g.gain.exponentialRampToValueAtTime(0.0001, time+0.12);
  o.stop(time+0.15);
}

function playOpenHat(time){
  const o = ctx.createOscillator(); o.type='square'; o.frequency.value=7000;
  const g = ctx.createGain(); g.gain.value=0.0001; g.connect(masterGain);
  o.connect(g); o.start(time);
  g.gain.setValueAtTime(0.0001, time); g.gain.exponentialRampToValueAtTime(0.4, time+0.001); g.gain.exponentialRampToValueAtTime(0.0001, time+0.3);
  o.stop(time+0.35);
}

function playCrash(time){
  const noise = ctx.createBufferSource();
  noise.buffer = makeNoiseBuffer();
  const filter = ctx.createBiquadFilter(); filter.type='highpass'; filter.frequency.value = 3000;
  const g = ctx.createGain(); g.gain.value=0.8; g.connect(masterGain);
  noise.connect(filter); filter.connect(g);
  g.gain.setValueAtTime(0.8, time); g.gain.exponentialRampToValueAtTime(0.001, time+2.0);
  noise.start(time); noise.stop(time+2.5);
}

function playRide(time){
  const o1 = ctx.createOscillator(); o1.type='triangle'; o1.frequency.value=4000;
  const o2 = ctx.createOscillator(); o2.type='sine'; o2.frequency.value=8000;
  const g = ctx.createGain(); g.gain.value=0.0001; g.connect(masterGain);
  o1.connect(g); o2.connect(g); o1.start(time); o2.start(time);
  g.gain.setValueAtTime(0.0001, time); g.gain.exponentialRampToValueAtTime(0.3, time+0.001); g.gain.exponentialRampToValueAtTime(0.0001, time+0.8);
  o1.stop(time+0.9); o2.stop(time+0.9);
}

function playTom(time){
  const o = ctx.createOscillator(); o.type='sine'; o.frequency.setValueAtTime(220, time); o.frequency.exponentialRampToValueAtTime(120, time+0.4);
  const g = ctx.createGain(); g.gain.value=1; g.connect(masterGain);
  g.gain.setValueAtTime(1, time); g.gain.exponentialRampToValueAtTime(0.001, time+0.6);
  o.connect(g); o.start(time); o.stop(time+0.8);
}

function playClap(time){
  // Multiple quick noise bursts to simulate clap
  for(let i = 0; i < 4; i++) {
    const noise = ctx.createBufferSource();
    noise.buffer = makeNoiseBuffer();
    const filter = ctx.createBiquadFilter(); filter.type='bandpass'; filter.frequency.value = 1500;
    const g = ctx.createGain(); g.gain.value=0.3; g.connect(masterGain);
    noise.connect(filter); filter.connect(g);
    const startTime = time + i * 0.01;
    g.gain.setValueAtTime(0.3, startTime); g.gain.exponentialRampToValueAtTime(0.001, startTime+0.1);
    noise.start(startTime); noise.stop(startTime+0.12);
  }
}

function playPerc(time){
  const o = ctx.createOscillator(); o.type='triangle'; o.frequency.setValueAtTime(800, time); o.frequency.exponentialRampToValueAtTime(200, time+0.2);
  const g = ctx.createGain(); g.gain.value=0.6; g.connect(masterGain);
  g.gain.setValueAtTime(0.6, time); g.gain.exponentialRampToValueAtTime(0.001, time+0.3);
  o.connect(g); o.start(time); o.stop(time+0.4);
}

// --- Melodic instruments ---
function playPiano(time, freq = 440){
  // Simple piano-like sound with multiple harmonics
  const o1 = ctx.createOscillator(); o1.type='sine'; o1.frequency.value=freq;
  const o2 = ctx.createOscillator(); o2.type='sine'; o2.frequency.value=freq*2;
  const o3 = ctx.createOscillator(); o3.type='sine'; o3.frequency.value=freq*3;
  const g1 = ctx.createGain(); g1.gain.value=0.6;
  const g2 = ctx.createGain(); g2.gain.value=0.3;
  const g3 = ctx.createGain(); g3.gain.value=0.1;
  const master = ctx.createGain(); master.connect(masterGain);
  o1.connect(g1); o2.connect(g2); o3.connect(g3);
  g1.connect(master); g2.connect(master); g3.connect(master);
  master.gain.setValueAtTime(0.7, time); master.gain.exponentialRampToValueAtTime(0.001, time+2.0);
  o1.start(time); o2.start(time); o3.start(time);
  o1.stop(time+2.5); o2.stop(time+2.5); o3.stop(time+2.5);
}

function playBass(time, freq = 110){
  const o = ctx.createOscillator(); o.type='sawtooth'; o.frequency.value=freq;
  const filter = ctx.createBiquadFilter(); filter.type='lowpass'; filter.frequency.value=800;
  const g = ctx.createGain(); g.gain.value=0.8; g.connect(masterGain);
  o.connect(filter); filter.connect(g);
  g.gain.setValueAtTime(0.8, time); g.gain.exponentialRampToValueAtTime(0.001, time+1.2);
  o.start(time); o.stop(time+1.5);
}

function playLead(time, freq = 880){
  const o = ctx.createOscillator(); o.type='sawtooth'; o.frequency.value=freq;
  const filter = ctx.createBiquadFilter(); filter.type='lowpass'; filter.frequency.value=3000;
  const g = ctx.createGain(); g.gain.value=0.6; g.connect(masterGain);
  o.connect(filter); filter.connect(g);
  g.gain.setValueAtTime(0.6, time); g.gain.exponentialRampToValueAtTime(0.001, time+1.5);
  o.start(time); o.stop(time+2.0);
}

function playSynthPad(time, freq = 220){
  const o1 = ctx.createOscillator(); o1.type='sawtooth'; o1.frequency.value=freq;
  const o2 = ctx.createOscillator(); o2.type='sawtooth'; o2.frequency.value=freq*1.5;
  const filter = ctx.createBiquadFilter(); filter.type='lowpass'; filter.frequency.value=1500;
  const g = ctx.createGain(); g.gain.value=0.4; g.connect(masterGain);
  o1.connect(filter); o2.connect(filter); filter.connect(g);
  g.gain.setValueAtTime(0.001, time); g.gain.exponentialRampToValueAtTime(0.4, time+0.3); g.gain.exponentialRampToValueAtTime(0.001, time+3.0);
  o1.start(time); o2.start(time); o1.stop(time+3.5); o2.stop(time+3.5);
}

function playPluck(time, freq = 440){
  const o = ctx.createOscillator(); o.type='triangle'; o.frequency.value=freq;
  const g = ctx.createGain(); g.gain.value=0.7; g.connect(masterGain);
  o.connect(g);
  g.gain.setValueAtTime(0.7, time); g.gain.exponentialRampToValueAtTime(0.001, time+0.8);
  o.start(time); o.stop(time+1.0);
}

function playOrgan(time, freq = 330){
  const o1 = ctx.createOscillator(); o1.type='sine'; o1.frequency.value=freq;
  const o2 = ctx.createOscillator(); o2.type='sine'; o2.frequency.value=freq*2;
  const o3 = ctx.createOscillator(); o3.type='sine'; o3.frequency.value=freq*3;
  const g = ctx.createGain(); g.gain.value=0.5; g.connect(masterGain);
  o1.connect(g); o2.connect(g); o3.connect(g);
  g.gain.setValueAtTime(0.001, time); g.gain.exponentialRampToValueAtTime(0.5, time+0.1); g.gain.exponentialRampToValueAtTime(0.001, time+2.5);
  o1.start(time); o2.start(time); o3.start(time);
  o1.stop(time+3.0); o2.stop(time+3.0); o3.stop(time+3.0);
}

// --- Effects ---
function playReverse(time){
  // Simulated reverse effect with sweep
  const o = ctx.createOscillator(); o.type='sawtooth'; o.frequency.setValueAtTime(100, time); o.frequency.exponentialRampToValueAtTime(1000, time+1.0);
  const g = ctx.createGain(); g.gain.value=0.5; g.connect(masterGain);
  o.connect(g);
  g.gain.setValueAtTime(0.001, time); g.gain.exponentialRampToValueAtTime(0.5, time+1.0); g.gain.exponentialRampToValueAtTime(0.001, time+1.2);
  o.start(time); o.stop(time+1.5);
}

function playSweep(time){
  const o = ctx.createOscillator(); o.type='sawtooth'; o.frequency.setValueAtTime(2000, time); o.frequency.exponentialRampToValueAtTime(200, time+0.8);
  const filter = ctx.createBiquadFilter(); filter.type='lowpass'; filter.frequency.setValueAtTime(4000, time); filter.frequency.exponentialRampToValueAtTime(500, time+0.8);
  const g = ctx.createGain(); g.gain.value=0.6; g.connect(masterGain);
  o.connect(filter); filter.connect(g);
  g.gain.setValueAtTime(0.6, time); g.gain.exponentialRampToValueAtTime(0.001, time+1.0);
  o.start(time); o.stop(time+1.2);
}

function playWhiteNoise(time){
  const noise = ctx.createBufferSource();
  noise.buffer = makeNoiseBuffer();
  const g = ctx.createGain(); g.gain.value=0.3; g.connect(masterGain);
  noise.connect(g);
  g.gain.setValueAtTime(0.3, time); g.gain.exponentialRampToValueAtTime(0.001, time+0.5);
  noise.start(time); noise.stop(time+0.8);
}

function makeNoiseBuffer(){
  const len = ctx.sampleRate * 1.0;
  const buf = ctx.createBuffer(1,len,ctx.sampleRate);
  const data = buf.getChannelData(0);
  for(let i=0;i<len;i++) data[i] = Math.random()*2-1;
  return buf;
}

// Hook pads UI
document.querySelectorAll('.pad').forEach(el=>{
  el.addEventListener('pointerdown',async (e)=>{ 
    await ensureResume(); 
    const p = el.dataset.pad; 
    const t = now();
    
    // Drum sounds
    if(p==='kick') playKick(t);
    else if(p==='snare') playSnare(t);
    else if(p==='hat') playHat(t);
    else if(p==='openhat') playOpenHat(t);
    else if(p==='crash') playCrash(t);
    else if(p==='ride') playRide(t);
    else if(p==='tom') playTom(t);
    else if(p==='clap') playClap(t);
    else if(p==='perc') playPerc(t);
    
    // Melodic instruments
    else if(p==='piano') playPiano(t, 440);
    else if(p==='bass') playBass(t, 110);
    else if(p==='lead') playLead(t, 880);
    else if(p==='synthpad') playSynthPad(t, 220);
    else if(p==='pluck') playPluck(t, 660);
    else if(p==='organ') playOrgan(t, 330);
    
    // Effects
    else if(p==='reverse') playReverse(t);
    else if(p==='sweep') playSweep(t);
    else if(p==='whitenoise') playWhiteNoise(t);
    
    // Visual feedback
    el.style.transform = 'scale(0.95)';
    setTimeout(() => { el.style.transform = ''; }, 100);
    
    // Add to sequencer if recording
    if(sequencer.recording) {
      addToSequencer(p);
    }
  });
});

// --- Transport / metronome ---
let metroInterval = null;
function startTransport(){ state.playing=true; startStopBtn.textContent='Stop'; if(state.metro) startMetro(); }
function stopTransport(){ state.playing=false; startStopBtn.textContent='Start'; stopMetro(); }
function startMetro(){ stopMetro(); const beatInterval = 60/state.bpm; metroInterval = setInterval(()=>{ const t=now()+0.02; playClick(t); }, beatInterval*1000); }
function stopMetro(){ if(metroInterval) clearInterval(metroInterval); metroInterval=null; }
function playClick(time){ const o = ctx.createOscillator(); const g = ctx.createGain(); g.connect(masterGain); o.connect(g); o.frequency.value=1200; g.gain.setValueAtTime(0.0001,time); g.gain.exponentialRampToValueAtTime(0.8,time+0.001); g.gain.exponentialRampToValueAtTime(0.0001,time+0.08); o.start(time); o.stop(time+0.1); }

// Ensure audio resume on interaction (mobile policies)
async function ensureResume(){ if(ctx.state==='suspended'){ await ctx.resume(); } }
window.addEventListener('pointerdown', ()=>{ ensureResume(); });

// --- XY Pad Implementation ---
const canvas = xyCanvas; const rect = ()=>canvas.getBoundingClientRect();
canvas.width = Math.floor(rect().width * devicePixelRatio);
canvas.height = Math.floor(rect().height * devicePixelRatio);
const g = canvas.getContext('2d'); g.scale(devicePixelRatio, devicePixelRatio);
let pointer = null; const centerA={x:80,y:80}; const centerB={x:canvas.width/devicePixelRatio-80,y:canvas.height/devicePixelRatio-80};
function drawGuide(){ g.clearRect(0,0,canvas.width/devicePixelRatio,canvas.height/devicePixelRatio);
  // gradient background
  const W = canvas.width/devicePixelRatio, H = canvas.height/devicePixelRatio;
  const grd = g.createLinearGradient(0,0,W,H); grd.addColorStop(0,'rgba(31,182,255,0.06)'); grd.addColorStop(1,'rgba(255,255,255,0.02)');
  g.fillStyle = grd; g.fillRect(0,0,W,H);
  // draw points A and B
  g.fillStyle='rgba(255,255,255,0.06)'; g.beginPath(); g.arc(centerA.x,centerA.y,12,0,Math.PI*2); g.fill();
  g.beginPath(); g.arc(centerB.x,centerB.y,12,0,Math.PI*2); g.fill();
  // line between
  g.strokeStyle='rgba(255,255,255,0.04)'; g.lineWidth=2; g.beginPath(); g.moveTo(centerA.x,centerA.y); g.lineTo(centerB.x,centerB.y); g.stroke();
  // pointer
  if(pointer){ g.fillStyle='rgba(31,182,255,0.9)'; g.beginPath(); g.arc(pointer.x,pointer.y,10,0,Math.PI*2); g.fill(); }
}

drawGuide();

function interp(a,b,t){return a+(b-a)*t}

async function handlePointer(x,y){ await ensureResume(); pointer = {x,y}; drawGuide();
  // compute t along line A->B projection
  const ax=centerA.x, ay=centerA.y, bx=centerB.x, by=centerB.y;
  const vx = bx-ax, vy = by-ay; const wx = x-ax, wy = y-ay;
  const vlen2 = vx*vx+vy*vy; let t = 0; if(vlen2>0) t = Math.max(0, Math.min(1, (vx*wx + vy*wy)/vlen2));
  // vertical influence (distance from line) -> map to pitch or volume
  const projx = interp(ax,bx,t), projy = interp(ay,by,t);
  const dist = Math.hypot(x-projx, y-projy);
  const maxDist = Math.min(canvas.width/devicePixelRatio, canvas.height/devicePixelRatio)/2;
  const yInfluence = 1 - Math.min(1, dist/maxDist);

  // Depending on mode, trigger appropriate sound
  if(state.mode==='oscillator'){
    playXYOsc(t, yInfluence);
  } else if(state.mode==='sampleBlend'){
    playBlendSample(t, yInfluence);
  } else if(state.mode==='drumMorph'){
    playMorphDrum(t, yInfluence);
  }
}

// --- XY mode implementations ---
function playXYOsc(t,yInf){
  const baseFreq = 220; // A3
  const freq = baseFreq * Math.pow(2, (t-0.5)*state.pitchRange);
  const o = ctx.createOscillator(); o.type='sawtooth'; o.frequency.value=freq;
  const g = ctx.createGain(); g.gain.value = yInf*0.6; g.connect(masterGain);
  // simple filter varying with t
  const f = ctx.createBiquadFilter(); f.type='lowpass'; f.frequency.value = interp(500,5000,t);
  o.connect(f); f.connect(g);
  o.start(); o.stop(now()+0.6);
}

function playBlendSample(t,yInf){
  // we synthesize two simple timbres and blend between them
  // timbreA = sine, timbreB = square
  const baseFreq = 440 * Math.pow(2,(t-0.5)*state.pitchRange);
  const a = ctx.createOscillator(); a.type='sine'; a.frequency.value=baseFreq;
  const b = ctx.createOscillator(); b.type='square'; b.frequency.value=baseFreq;
  const gA = ctx.createGain(); const gB = ctx.createGain(); gA.connect(masterGain); gB.connect(masterGain);
  gA.gain.value = 1-t; gB.gain.value = t;
  const env = ctx.createGain(); env.connect(masterGain);
  a.connect(gA); b.connect(gB);
  gA.connect(env); gB.connect(env);
  env.gain.setValueAtTime(yInf,now()); env.gain.exponentialRampToValueAtTime(0.001, now()+0.7);
  a.start(); b.start(); a.stop(now()+0.7); b.stop(now()+0.7);
}

function playMorphDrum(t,yInf){
  // choose mix between kick and snare
  const time = now();
  if(t<0.4){ playKick(time); }
  else if(t<0.7){ playTom(time); }
  else { playSnare(time); }
}

// Pointer events
let isDown=false;
function getXYFromEvent(e){ const r=rect(); const x = (e.clientX||e.touches[0].clientX) - r.left; const y = (e.clientY||e.touches[0].clientY) - r.top; return {x,y}; }
canvas.addEventListener('pointerdown',(ev)=>{ isDown=true; const p=getXYFromEvent(ev); handlePointer(p.x,p.y); });
canvas.addEventListener('pointermove',(ev)=>{ if(!isDown) return; const p=getXYFromEvent(ev); handlePointer(p.x,p.y); });
canvas.addEventListener('pointerup',(ev)=>{ isDown=false; pointer=null; drawGuide(); });
canvas.addEventListener('pointercancel',(ev)=>{ isDown=false; pointer=null; drawGuide(); });

// Resize handling
window.addEventListener('resize',()=>{ canvas.width = Math.floor(rect().width * devicePixelRatio); canvas.height = Math.floor(rect().height * devicePixelRatio); g.scale(devicePixelRatio,devicePixelRatio); centerB.x = canvas.width/devicePixelRatio-80; centerB.y = canvas.height/devicePixelRatio-80; drawGuide(); });

// Presets (localStorage)
function savePreset(){ const p = {bpm:state.bpm, pitchRange:state.pitchRange, masterVol:state.masterVol, mode:state.mode}; const arr = JSON.parse(localStorage.getItem('sint_presets')||'[]'); arr.push(p); localStorage.setItem('sint_presets', JSON.stringify(arr)); renderPresets(); }
function renderPresets(){ const list = document.getElementById('presets'); list.innerHTML=''; const arr = JSON.parse(localStorage.getItem('sint_presets')||'[]'); arr.forEach((pr,i)=>{ const el=document.createElement('div'); el.className='preset'; el.textContent=`Preset ${i+1} (BPM ${pr.bpm})`; el.addEventListener('click',()=>{ state.bpm=pr.bpm; bpmSlider.value=pr.bpm; state.pitchRange=pr.pitchRange; pitchRange.value=pr.pitchRange; state.masterVol=pr.masterVol; masterVol.value=pr.masterVol; state.mode=pr.mode; modeSel.value=pr.mode; }); list.appendChild(el); }); }

document.getElementById('savePreset').addEventListener('click',savePreset);
renderPresets();

// Utility: resume audio on first gesture
window.addEventListener('pointerdown',()=>{ if(ctx.state==='suspended') ctx.resume(); });

// --- Sequencer Implementation ---
function initSequencer() {
  const table = document.getElementById('sequencerTable');
  table.innerHTML = '';
  
  // Create header
  const thead = document.createElement('thead');
  const headerRow = document.createElement('tr');
  
  // Track name header
  const trackHeader = document.createElement('th');
  trackHeader.textContent = 'TRACKS';
  headerRow.appendChild(trackHeader);
  
  // Step number headers (1-16)
  for(let step = 0; step < sequencer.steps; step++) {
    const stepHeader = document.createElement('th');
    stepHeader.textContent = String(step + 1).padStart(2, '0');
    headerRow.appendChild(stepHeader);
  }
  
  thead.appendChild(headerRow);
  table.appendChild(thead);
  
  // Create body
  const tbody = document.createElement('tbody');
  
  // Create track rows
  sequencer.tracks.forEach((track, trackIndex) => {
    const row = document.createElement('tr');
    row.className = 'track-row';
    
    // Track name cell
    const nameCell = document.createElement('td');
    nameCell.className = 'track-name-cell';
    nameCell.textContent = track.name;
    row.appendChild(nameCell);
    
    // Step cells
    for(let step = 0; step < sequencer.steps; step++) {
      const stepCell = document.createElement('td');
      stepCell.className = 'step-cell';
      stepCell.dataset.track = trackIndex;
      stepCell.dataset.step = step;
      
      if(track.pattern[step]) {
        stepCell.classList.add('active');
      }
      
      stepCell.addEventListener('click', () => {
        track.pattern[step] = !track.pattern[step];
        stepCell.classList.toggle('active', track.pattern[step]);
      });
      
      row.appendChild(stepCell);
    }
    
    tbody.appendChild(row);
  });
  
  table.appendChild(tbody);
}

function startSequencer() {
  if(sequencer.playing) return;
  
  sequencer.playing = true;
  sequencer.currentStep = 0;
  seqPlayBtn.textContent = '⏸ PAUSE';
  
  const stepTime = 60 / sequencer.bpm / 4; // 16th notes
  
  sequencer.interval = setInterval(() => {
    playSequencerStep();
    updatePlayhead();
    sequencer.currentStep = (sequencer.currentStep + 1) % sequencer.steps;
  }, stepTime * 1000);
  
  // Start recording if needed
  if(sequencer.recording && !sequencer.mediaRecorder) {
    startAudioRecording();
  }
}

function stopSequencer() {
  sequencer.playing = false;
  sequencer.currentStep = 0;
  seqPlayBtn.textContent = '▶ PLAY';
  
  if(sequencer.interval) {
    clearInterval(sequencer.interval);
    sequencer.interval = null;
  }
  
  updatePlayhead();
  
  // Stop recording if active
  if(sequencer.mediaRecorder && sequencer.mediaRecorder.state === 'recording') {
    sequencer.mediaRecorder.stop();
  }
}

function playSequencerStep() {
  const time = now();
  
  sequencer.tracks.forEach(track => {
    if(track.pattern[sequencer.currentStep]) {
      playSound(track.sound, time);
    }
  });
}

function playSound(soundName, time) {
  // Map sounds to functions
  const soundMap = {
    kick: () => playKick(time),
    snare: () => playSnare(time),
    hat: () => playHat(time),
    openhat: () => playOpenHat(time),
    crash: () => playCrash(time),
    ride: () => playRide(time),
    tom: () => playTom(time),
    clap: () => playClap(time),
    perc: () => playPerc(time),
    piano: () => playPiano(time, 440),
    bass: () => playBass(time, 110),
    lead: () => playLead(time, 880),
    synthpad: () => playSynthPad(time, 220),
    pluck: () => playPluck(time, 660),
    organ: () => playOrgan(time, 330),
    reverse: () => playReverse(time),
    sweep: () => playSweep(time),
    whitenoise: () => playWhiteNoise(time)
  };
  
  if(soundMap[soundName]) {
    soundMap[soundName]();
  }
}

function updatePlayhead() {
  const playhead = document.getElementById('playhead');
  const table = document.getElementById('sequencerTable');
  
  if(!table) return;
  
  const tableRect = table.getBoundingClientRect();
  const firstRow = table.querySelector('tr');
  const trackNameCell = firstRow?.querySelector('th');
  const trackNameWidth = trackNameCell?.getBoundingClientRect().width || 100;
  
  const availableWidth = tableRect.width - trackNameWidth;
  const stepWidth = availableWidth / sequencer.steps;
  const playheadX = trackNameWidth + (sequencer.currentStep * stepWidth) + (stepWidth / 2);
  
  playhead.style.left = playheadX + 'px';
  
  // Update current step highlighting
  document.querySelectorAll('.step-cell.current').forEach(cell => {
    cell.classList.remove('current');
  });
  
  if(sequencer.playing) {
    document.querySelectorAll(`[data-step="${sequencer.currentStep}"]`).forEach(cell => {
      if(cell.classList.contains('step-cell')) {
        cell.classList.add('current');
      }
    });
  }
}

function addToSequencer(soundName) {
  // Find the track for this sound
  const track = sequencer.tracks.find(t => t.sound === soundName);
  if(track) {
    track.pattern[sequencer.currentStep] = true;
    initSequencer(); // Refresh UI
  }
}

function clearSequencer() {
  sequencer.tracks.forEach(track => {
    track.pattern.fill(false);
  });
  initSequencer();
}

function toggleRecording() {
  sequencer.recording = !sequencer.recording;
  seqRecordBtn.classList.toggle('recording', sequencer.recording);
  seqRecordBtn.textContent = sequencer.recording ? '⏹ PARAR GRAV' : '⏺ GRAVAR';
  
  if(!sequencer.recording && sequencer.mediaRecorder && sequencer.mediaRecorder.state === 'recording') {
    sequencer.mediaRecorder.stop();
  }
}

// Audio recording functions
async function startAudioRecording() {
  try {
    // Create audio destination for recording
    const dest = ctx.createMediaStreamDestination();
    masterGain.connect(dest);
    
    sequencer.recordedChunks = [];
    sequencer.mediaRecorder = new MediaRecorder(dest.stream);
    
    sequencer.mediaRecorder.ondataavailable = (event) => {
      if(event.data.size > 0) {
        sequencer.recordedChunks.push(event.data);
      }
    };
    
    sequencer.mediaRecorder.onstop = () => {
      const blob = new Blob(sequencer.recordedChunks, { type: 'audio/webm' });
      downloadRecording(blob);
    };
    
    sequencer.mediaRecorder.start();
    console.log('🎙️ Gravação iniciada!');
  } catch (error) {
    console.error('Erro ao iniciar gravação:', error);
  }
}

function downloadRecording(blob) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `synthbat-recording-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.webm`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  console.log('🎵 Gravação salva!');
}

function saveSequence() {
  const sequence = {
    bpm: sequencer.bpm,
    tracks: sequencer.tracks.map(track => ({
      name: track.name,
      sound: track.sound,
      pattern: [...track.pattern]
    }))
  };
  
  const blob = new Blob([JSON.stringify(sequence, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `synthbat-sequence-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  console.log('💾 Sequência salva!');
}

function loadSequence() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = (event) => {
    const file = event.target.files[0];
    if(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const sequence = JSON.parse(e.target.result);
          
          // Load BPM
          sequencer.bpm = sequence.bpm || 120;
          seqBpmSlider.value = sequencer.bpm;
          seqBpmDisplay.textContent = sequencer.bpm;
          
          // Load patterns
          sequence.tracks.forEach((loadedTrack, index) => {
            if(sequencer.tracks[index]) {
              sequencer.tracks[index].pattern = [...loadedTrack.pattern];
            }
          });
          
          initSequencer();
          console.log('📁 Sequência carregada!');
        } catch (error) {
          console.error('Erro ao carregar sequência:', error);
          alert('Erro ao carregar arquivo. Verifique se é um arquivo de sequência válido.');
        }
      };
      reader.readAsText(file);
    }
  };
  
  input.click();
}

// Initialize sequencer on load
initSequencer();

// Final note: friendly help
console.log('🎵 Pad Musical Completo com Sequenciador carregado! 🎵');
console.log('- 18 instrumentos musicais coloridos');
console.log('- Sequenciador de 16 steps com 8 trilhas');
console.log('- Gravação de áudio em tempo real');
console.log('- Salvamento/carregamento de sequências');
console.log('- Área XY para controle em tempo real');
console.log('Divirta-se criando música! 🎶🎛️');
</script>
</body>
</html>
